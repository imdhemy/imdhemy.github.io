<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>How to avoid boilerplate code in Symfony Voters</title>
    <meta name="description"
          content="Symfony voters are the way to go when you need to centralize the authorization logic of your application. There have been multiple trials to improve the way ...">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:ital,wght@0,100..900;1,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">

    <link rel="canonical" href="https://imdhemy.com/blog/php/how-to-avoid-boilerplate-code-in-symfony-voters.html/">
    <link rel="stylesheet" href="/assets/css/main.css?v=1.0.0">
    
    <link rel="icon" type="image/png" href="/assets/theme/favicon.png">
    
    

    
    <!-- Facebook Meta Tags -->
<meta property="og:title" content="How to avoid boilerplate code in Symfony Voters">
<meta property="og:type" content="article">
<meta property="og:image" content="https://imdhemy.com/assets/img/vote.jpeg">
<meta property="og:url" content="https://imdhemy.com/blog/php/how-to-avoid-boilerplate-code-in-symfony-voters.html/">
<meta property="og:description"
      content="Symfony voters are the way to go when you need to centralize the authorization logic of your application. There have been multiple trials to improve the way ...">
<meta property="og:site_name" content="Imdhemy">

<!-- Twitter Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="How to avoid boilerplate code in Symfony Voters">
<meta name="twitter:description"
      content="Symfony voters are the way to go when you need to centralize the authorization logic of your application. There have been multiple trials to improve the way ...">
<meta name="twitter:image" content="https://imdhemy.com/assets/img/vote.jpeg">


    

</head>
<body class="min-h-screen">
<div class="min-h-screen">
    <header class="relative" id="main-header">
    <div class="container mx-auto">
        <div class="flex py-6 lg:py-14 p-5 lg:px-0">
            <!-- begin logo -->
            <div class="flex-auto">
                <div>
                    <a href="/" class="text-gray-900 text-3xl font-bold">
                        Imdhemy
                    </a>
                </div>
            </div>
            <!-- end logo -->
            <!-- begin right part -->
            <div class="flex-auto">
                <div class="flex justify-end lg:hidden">
                    <button type="button" class="menu-toggle" data-target="#mobile-nav">
                        <ion-icon name="menu-outline"></ion-icon>
                    </button>
                </div>

                <div class="hidden lg:flex justify-end">
                    <ul class="flex items-center">
                        
                        <li class="ml-10">
                            <a href="/"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Home
                            </a>
                        </li>
                        
                        <li class="ml-10">
                            <a href="/blog"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Blog
                            </a>
                        </li>
                        
                        <li class="ml-10">
                            <a href="/about"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                About
                            </a>
                        </li>
                        
                    </ul>
                </div>
                <!-- end right part -->
            </div>
            <!-- begin mobile nav -->
            <nav id="mobile-nav"
                 class="menu -z-10 opacity-0 absolute top-32 right-6 block min-w-fit w-40 bg-white p-5 rounded-md shadow-md ease-linear">
                <div class="ml-auto">
                    <ul class="p-0 m-0 flex-column items-center">
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Home
                            </a>
                        </li>
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/blog"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Blog
                            </a>
                        </li>
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/about"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                About
                            </a>
                        </li>
                        
                    </ul>
                </div>
            </nav>
            <!-- end mobile nav -->
        </div>
    </div>
</header>

    <main>
        <div class="max-w-screen-md mx-auto bg-white p-5">
    <h1 class="font-black font-sans text-2xl lg:text-4xl post-title">How to avoid boilerplate code in Symfony Voters</h1>
</div>

<div class="max-w-screen-md mx-auto bg-white p-5">
    <div class="flex justify-between flex-wrap my-2">
        <div class="flex items-center mr-8">
            <img src="/theme/images/avatar.jpeg" alt=""
                 class="rounded-full w-10 h-10 mr-3 block"/>
            <div>
                <p class="text-gray-700 text-sm font-bold">Dhemy</p>
                <p class="text-gray-500 text-xs">
                    April 3, 2024 - 10 min read
                </p>
            </div>
        </div>
    </div>

    <div>
        
        <div class="flex mb-5">
    
</div>

    </div>

    
    <div class="relative overflow-hidden">
        <img src="/assets/img/vote.jpeg"
             alt="How to avoid boilerplate code in Symfony Voters"
             class="w-full h-auto rounded"/>
        <!-- Image source -->
        
        <div class="bg-white text-xs text-gray-500 px-2 py-1">
            Image source: https://unsplash.com/photos/white-and-black-letter-b-9xp4F57ATzs
        </div>
        
    </div>
    
</div>


<div class="m-auto max-w-screen-md bg-white p-5 text-xl content">
    <p>Symfony voters are the way to go when you need to centralize the authorization logic of your application. There have
been multiple trials to improve the way we write voters, one of them was by introducing the <code class="language-plaintext highlighter-rouge">AbstractVoter</code> class in
<a href="https://symfony.com/blog/new-in-symfony-2-6-simpler-security-voters">Symfony 2.6</a>. Later on, it was deprecated in
<a href="https://symfony.com/blog/new-in-symfony-2-8-simpler-security-voters">Symfony 2.8</a> to be removed in v3.0 with the
introduction of the <code class="language-plaintext highlighter-rouge">Voter</code>class. The continuous improvement didn’t stop there, and I believe it will not.</p>

<p>In this post, I will contribute to the trials of improving the way we write voters by introducing the <code class="language-plaintext highlighter-rouge">CanDoVoter</code>.</p>

<h2 id="the-problem">The problem</h2>

<p>Suppose the logic to decide whether a user can <code class="language-plaintext highlighter-rouge">view</code> or <code class="language-plaintext highlighter-rouge">edit</code> a <code class="language-plaintext highlighter-rouge">Post</code> object is pretty complex. For example, a User
can always edit or view a Post they created. And if a Post is marked as “public”, anyone can view it. We can write
a <code class="language-plaintext highlighter-rouge">PostVoter</code> to handle this logic.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//src/Acme/Post/PostVoter.php</span>
<span class="kn">namespace</span> <span class="nn">App\Acme\Post</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Domain\Entity\Post</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Domain\Entity\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authorization\Voter\Voter</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">PostVoter</span> <span class="kd">extends</span> <span class="nc">Voter</span>
<span class="p">{</span>   
    <span class="k">protected</span> <span class="k">function</span> <span class="n">supports</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="p">[</span><span class="s1">'get'</span><span class="p">,</span> <span class="s1">'update'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$subject</span> <span class="k">instanceof</span> <span class="nc">Post</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">voteOnAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="kt">TokenInterface</span> <span class="nv">$token</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="nf">getUser</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span> <span class="k">instanceof</span> <span class="nc">User</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// This means if the user is not logged in, they can't view or edit the post</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$subject</span><span class="p">;</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nv">$post</span> <span class="k">instanceof</span> <span class="nc">Post</span><span class="p">);</span>
        
        <span class="c1">// The user can always edit or view a post they created</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$user</span> <span class="o">===</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="nf">getAuthor</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// If the post is public, anyone can view it</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$attribute</span> <span class="o">===</span> <span class="s1">'get'</span> <span class="o">&amp;&amp;</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="nf">isPublic</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// otherwise, the user can't view or edit the post</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, suppose we have another entity, <code class="language-plaintext highlighter-rouge">Comment</code>, and we need to write a <code class="language-plaintext highlighter-rouge">CommentVoter</code> to handle the logic of whether
a user can perform some actions on a <code class="language-plaintext highlighter-rouge">Comment</code> object. We will end up repeating a similar code in <code class="language-plaintext highlighter-rouge">supports()</code> and
the beginning of <code class="language-plaintext highlighter-rouge">voteOnAttribute()</code> methods till we get the <code class="language-plaintext highlighter-rouge">user</code> and <code class="language-plaintext highlighter-rouge">subject</code> objects.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//src/Acme/Comment/CommentVoter.php</span>

<span class="kn">namespace</span> <span class="nn">App\Acme\Comment</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Domain\Entity\Comment</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Domain\Entity\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authorization\Voter\Voter</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">CommentVoter</span> <span class="kd">extends</span> <span class="nc">Voter</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">supports</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="p">[</span><span class="s1">'get'</span><span class="p">,</span> <span class="s1">'update'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$subject</span> <span class="k">instanceof</span> <span class="nc">Comment</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">voteOnAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="kt">TokenInterface</span> <span class="nv">$token</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="nf">getUser</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span> <span class="k">instanceof</span> <span class="nc">User</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$comment</span> <span class="o">=</span> <span class="nv">$subject</span><span class="p">;</span>

        <span class="c1">// Do the logic here</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="avoiding-the-repeated-code-in-the-supports">Avoiding the repeated code in the supports()</h2>

<p>The first step is to avoid the repeated code in the <code class="language-plaintext highlighter-rouge">supports()</code> method. The <code class="language-plaintext highlighter-rouge">supports()</code> method goal is to check if the
voter supports the given attribute and subject. We can extract them to configuration properties.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">App\Foundation\Security</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authorization\Voter\Voter</span><span class="p">;</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CanDoVoter</span> <span class="kd">extends</span> <span class="nc">Voter</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var string[] the attributes that this voter supports
     */</span>
    <span class="k">protected</span> <span class="kt">array</span> <span class="nv">$supportedAttributes</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="cd">/**
     * @var class-string the subject that this voter supports
     */</span>
    <span class="k">protected</span> <span class="kt">string</span> <span class="nv">$supportedClass</span><span class="p">;</span>
    
    <span class="k">protected</span> <span class="k">function</span> <span class="n">supports</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="kt">mixed</span> <span class="nv">$subject</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">supportedAttributes</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_a</span><span class="p">(</span><span class="nv">$subject</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">supportedClass</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="avoiding-the-repeated-code-in-the-voteonattribute">Avoiding the repeated code in the voteOnAttribute()</h2>

<p>The <code class="language-plaintext highlighter-rouge">voteOnAttribute()</code> should perform the actual voting logic to decide whether the user can perform the given
attribute on the given subject. To do so, we need to get the <code class="language-plaintext highlighter-rouge">user</code> and <code class="language-plaintext highlighter-rouge">subject</code> objects. We can extract this code
as follows:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">App\Foundation\Security</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authorization\Voter\Voter</span><span class="p">;</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CanDoVoter</span> <span class="kd">extends</span> <span class="nc">Voter</span>
<span class="p">{</span>
    <span class="c1">// The supports() method is removed for brevity</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">voteOnAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="kt">mixed</span> <span class="nv">$subject</span><span class="p">,</span> <span class="kt">TokenInterface</span> <span class="nv">$token</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="nv">$method</span> <span class="o">=</span> <span class="s1">'can'</span><span class="mf">.</span><span class="nb">ucfirst</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">);</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="nf">getUser</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$user</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$vote</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$method</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">);</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nb">is_bool</span><span class="p">(</span><span class="nv">$vote</span><span class="p">));</span>

        <span class="k">return</span> <span class="nv">$vote</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Based on the <code class="language-plaintext highlighter-rouge">voteOnAttribute()</code> implementation, we need to define a method for each supported attribute. The method
name should be <code class="language-plaintext highlighter-rouge">can</code> followed by the attribute name with the first letter capitalized. For example, if the supported
attributes are <code class="language-plaintext highlighter-rouge">['get', 'update']</code>, we should define <code class="language-plaintext highlighter-rouge">canGet()</code> and <code class="language-plaintext highlighter-rouge">canUpdate()</code> methods. The <code class="language-plaintext highlighter-rouge">user</code> is passed as the
first argument, and the <code class="language-plaintext highlighter-rouge">subject</code> is passed as the second argument.</p>

<h2 id="introducing-the-candovoter">Introducing the CanDoVoter</h2>

<p>A final version of the <code class="language-plaintext highlighter-rouge">CanDoVoter</code> class is as follows:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">App\Foundation\Security</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\Security\Core\Authorization\Voter\Voter</span><span class="p">;</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CanDoVoter</span> <span class="kd">extends</span> <span class="nc">Voter</span>
<span class="p">{</span>   
    <span class="k">public</span> <span class="k">const</span> <span class="no">LIST</span> <span class="o">=</span> <span class="s1">'list'</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">GET</span> <span class="o">=</span> <span class="s1">'get'</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">CREATE</span> <span class="o">=</span> <span class="s1">'create'</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">UPDATE</span> <span class="o">=</span> <span class="s1">'update'</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">DELETE</span> <span class="o">=</span> <span class="s1">'delete'</span><span class="p">;</span>
    
    <span class="k">protected</span> <span class="kt">array</span> <span class="nv">$supportedAttributes</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="kt">string</span> <span class="nv">$supportedClass</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">supports</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="kt">mixed</span> <span class="nv">$subject</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">supportedAttributes</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_a</span><span class="p">(</span><span class="nv">$subject</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">supportedClass</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">voteOnAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$attribute</span><span class="p">,</span> <span class="kt">mixed</span> <span class="nv">$subject</span><span class="p">,</span> <span class="kt">TokenInterface</span> <span class="nv">$token</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="nv">$method</span> <span class="o">=</span> <span class="s1">'can'</span><span class="mf">.</span><span class="nb">ucfirst</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">);</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="nf">getUser</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$user</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$vote</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$method</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">);</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nb">is_bool</span><span class="p">(</span><span class="nv">$vote</span><span class="p">));</span>

        <span class="k">return</span> <span class="nv">$vote</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="using-the-candovoter">Using the CanDoVoter</h2>

<p>Now, we can use the <code class="language-plaintext highlighter-rouge">CanDoVoter</code> to write the <code class="language-plaintext highlighter-rouge">PostVoter</code> as follows:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">App\Acme\Post</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Domain\Entity\Post</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Domain\Entity\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Foundation\Security\CanDoVoter</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">PostVoter</span> <span class="kd">extends</span> <span class="nc">CanDoVoter</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="kt">array</span> <span class="nv">$supportedAttributes</span> <span class="o">=</span> <span class="p">[</span><span class="k">self</span><span class="o">::</span><span class="no">GET</span><span class="p">,</span> <span class="k">self</span><span class="o">::</span><span class="no">UPDATE</span><span class="p">];</span>
    <span class="k">protected</span> <span class="kt">string</span> <span class="nv">$supportedClass</span> <span class="o">=</span> <span class="nc">Post</span><span class="o">::</span><span class="n">class</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">canGet</span><span class="p">(</span><span class="kt">User</span> <span class="nv">$user</span><span class="p">,</span> <span class="kt">Post</span> <span class="nv">$post</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>   
        <span class="k">if</span> <span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="nf">isPublic</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">===</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="nf">getAuthor</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">canUpdate</span><span class="p">(</span><span class="kt">User</span> <span class="nv">$user</span><span class="p">,</span> <span class="kt">Post</span> <span class="nv">$post</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$user</span> <span class="o">===</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="nf">getAuthor</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And in your controller, you can use the voter as follows:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">App\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Domain\Entity\Post</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Bundle\FrameworkBundle\Controller\AbstractController</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Acme\Post\PostVoter</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">PostController</span> <span class="kd">extends</span> <span class="nc">AbstractController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">show</span><span class="p">(</span><span class="kt">Post</span> <span class="nv">$post</span><span class="p">):</span> <span class="kt">Response</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">denyAccessUnlessGranted</span><span class="p">(</span><span class="nc">PostVoter</span><span class="o">::</span><span class="no">GET</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span>
        
        <span class="c1">// The logic to show the post</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">update</span><span class="p">(</span><span class="kt">Post</span> <span class="nv">$post</span><span class="p">):</span> <span class="kt">Response</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">denyAccessUnlessGranted</span><span class="p">(</span><span class="nc">PostVoter</span><span class="o">::</span><span class="no">UPDATE</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span>
        
        <span class="c1">// The logic to update the post</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="testing-the-candovoter">Testing the canDoVoter</h2>

<p>We have discussed before <a href="/blog/testing/how-to-organize-your-unit-tests.html/">how to organize our unit tests</a>.
It’s a good practice to write unit tests that document your business logic, and testing the interface is the way to go.
That means you should write your tests against the <code class="language-plaintext highlighter-rouge">vote()</code> method not the <code class="language-plaintext highlighter-rouge">can*()</code> methods. The <code class="language-plaintext highlighter-rouge">can*()</code> methods
should be <code class="language-plaintext highlighter-rouge">protected</code> methods, and you should not test them directly.</p>

<div class="tip">

  <p>Always test the public interface of your classes. In this case, the public interface is the <code class="language-plaintext highlighter-rouge">vote()</code> method.</p>

</div>

<p>Below is an example of how to test the <code class="language-plaintext highlighter-rouge">PostVoter</code>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">PostVoterTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">any_user_can_view_a_public_post</span><span class="p">():</span> <span class="kt">void</span> 
   <span class="p">{</span>
       <span class="c1">// Arrange</span>
       <span class="nv">$post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Post</span><span class="p">();</span>
       <span class="nv">$post</span><span class="o">-&gt;</span><span class="nf">setPublic</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
       <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">();</span>
       <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createMock</span><span class="p">(</span><span class="nc">TokenInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
       <span class="nv">$token</span><span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'getUser'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">willReturn</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
       <span class="nv">$sut</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PostVoter</span><span class="p">();</span>
       
       <span class="c1">// Act</span>
       <span class="nv">$actual</span> <span class="o">=</span> <span class="nv">$sut</span><span class="o">-&gt;</span><span class="nf">vote</span><span class="p">(</span><span class="nv">$token</span><span class="p">,</span> <span class="nv">$post</span><span class="p">,</span> <span class="p">[</span><span class="nc">PostVoter</span><span class="o">::</span><span class="no">GET</span><span class="p">]);</span>
       
       <span class="c1">// Assert</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Voter</span><span class="o">::</span><span class="no">ACCESS_GRANTED</span><span class="p">,</span> <span class="nv">$actual</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Avoid test names like: <code class="language-plaintext highlighter-rouge">it_should_fail_when_the_user_is_not_the_author()</code>. Instead, use test names that describe the
behavior of the system under test.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- it_should_fail_when_the_user_is_not_the_author()
</span><span class="err">
</span><span class="gi">+ only_the_author_can_update_the_post()
+ only_the_author_can_view_a_private_post()
+ any_user_can_view_a_public_post()
</span></code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>You can have the <code class="language-plaintext highlighter-rouge">CanDoVoter</code> and much more out-of the box by using
the <a href="https://github.com/symblaze/security-bundle">Symblaze Security Bundle</a>.</p>

<p>In this post, we have introduced a new way to write Symfony voters with less boilerplate code, the <code class="language-plaintext highlighter-rouge">CanDoVoter</code>. The
<code class="language-plaintext highlighter-rouge">CanDoVoter</code> class is an abstract class that you can extend to write your voters. Improving the way we write voters
will make our codebase more maintainable and easier to read. I hope you find this post helpful, and I would love to
hear your feedback.</p>

</div>


    </main>
    <section class="sticky top-[100vh]">
    <div class="p-10">
        <div class="max-w-screen-md mx-auto">
            <p class="text-center">
                <!-- 2001 - jekyll current year -->
                &copy; 2021 - 2024 . imdhemy.com Published by Jekyll, hosted on GitHub Pages.
            </p>
        </div>
    </div>
</section>

</div>


<!-- Ion icons -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

<!-- Main JS file -->
<script src="/assets/js/dist/main.js?v=1.0.0"></script>
</body>
</html>
