<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>PHP Real-world use cases of singleton design pattern</title>
    <meta name="description"
          content="The singleton pattern ensures that a class has only one instance and provides global access to it. Okay, many developers consider the singleton is an anti-pa...">
    <link rel="canonical" href="https://imdhemy.com/blog/php/real-world-use-cases-of-sinlgeton-in-php.html">
    <link rel="stylesheet" href="/assets/css/main.css?v=1.0.0">
    
</head>
<body class="min-h-screen">
<div class="min-h-screen">
    <header class="relative" id="main-header">
    <div class="container mx-auto">
        <div class="flex py-6 lg:py-14 p-5 lg:px-0">
            <!-- begin logo -->
            <div class="flex-auto">
                <div>
                    <a href="/" class="text-gray-900 text-3xl font-bold">
                        Imdhemy
                    </a>
                </div>
            </div>
            <!-- end logo -->
            <!-- begin right part -->
            <div class="flex-auto">
                <div class="flex justify-end lg:hidden">
                    <button type="button" class="menu-toggle" data-target="#mobile-nav">
                        <ion-icon name="menu-outline"></ion-icon>
                    </button>
                </div>

                <div class="hidden lg:flex justify-end">
                    <ul class="flex items-center">
                        
                        <li class="ml-10">
                            <a href="/"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Home
                            </a>
                        </li>
                        
                        <li class="ml-10">
                            <a href="/blog"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Blog
                            </a>
                        </li>
                        
                        <li class="ml-10">
                            <a href="/about"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                About
                            </a>
                        </li>
                        
                    </ul>
                </div>
                <!-- end right part -->
            </div>
            <!-- begin mobile nav -->
            <nav id="mobile-nav"
                 class="menu -z-10 opacity-0 absolute top-32 right-6 block min-w-fit w-40 bg-white p-5 rounded-md shadow-md ease-linear">
                <div class="ml-auto">
                    <ul class="p-0 m-0 flex-column items-center">
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Home
                            </a>
                        </li>
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/blog"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Blog
                            </a>
                        </li>
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/about"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                About
                            </a>
                        </li>
                        
                    </ul>
                </div>
            </nav>
            <!-- end mobile nav -->
        </div>
    </div>
</header>

    <main>
        <div class="max-w-screen-lg mx-auto bg-white p-5">
    <h1 class="font-black font-sans text-2xl lg:text-7xl post-title">PHP Real-world use cases of singleton design pattern</h1>
</div>

<div class="max-w-screen-md mx-auto bg-white p-5">
    <div class="flex justify-between flex-wrap my-2">
        <div class="flex items-center mr-8">
            <img src="/theme/images/avatar.jpeg" alt=""
                 class="rounded-full w-10 h-10 mr-3 block"/>
            <div>
                <p class="text-gray-700 text-sm font-bold">Dhemy</p>
                <p class="text-gray-500 text-xs">
                    December 30, 2021 - 4 min read
                </p>
            </div>
        </div>
    </div>

    <div>
        
        <div class="flex mb-5">
    
</div>

    </div>

    
</div>


<div class="max-w-screen-md mx-auto bg-white p-5 text-xl content">
    <p>The singleton pattern ensures that a class has only one instance and provides global access to it. Okay, many developers consider the singleton is an anti-pattern and many others don’t. The most common reason for using a singleton is to control access to some shared resources, database connection which is an expensive resource or a file.</p>

<p><strong>The singleton pattern is responsible for:</strong></p>
<ul>
  <li>Creating an instance of its class.</li>
  <li>Ensures that a class has just a single instance.</li>
</ul>

<p>This obviously violates the Single Responsibility Principle, as the pattern solves two problems at the same time.</p>

<p>In the following lines, I’ll start by explaining <strong>how to implement a singleton</strong>, then I’ll discuss how <strong>Laravel Container</strong> uses the singleton pattern, Finally, show you how the Local Adapter within <strong>Flysystem</strong> PHP package uses the same concept to manipulate files.</p>

<h2 id="how-to-implement-a-singleton">How to implement a singleton</h2>
<p>The Singleton class declares the static method <code class="language-plaintext highlighter-rouge">getInstance</code> that returns the same instance of its class. To do so, we declare a static private property that holds the instance. By checking its value we can decide whether to create a new instance or return the already instantiated one. The Singleton <code class="language-plaintext highlighter-rouge">constructor</code> should be hidden from the client code. Calling the <code class="language-plaintext highlighter-rouge">getInstance</code> method should be the only way to create an instance of the Singleton class. Cloning the object should be prevented as well.</p>

<p><strong>I start by writing tests…</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//SingletonTest.php
<span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Tests</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Com\Imdhemy\Singleton</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Error</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">SingletonTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_can_be_instantiated_by_a_static_factory_method</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$instance</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertInstanceOf</span><span class="p">(</span><span class="nc">Singleton</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="nv">$instance</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_must_return_the_same_instance_every_time</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$firstCall</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
        <span class="nv">$secondCall</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nv">$firstCall</span><span class="p">,</span> <span class="nv">$secondCall</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_should_not_be_instantiated_through_a_constructor</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">expectException</span><span class="p">(</span><span class="nc">Error</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="k">new</span> <span class="nc">Singleton</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_should_not_be_cloned</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">expectException</span><span class="p">(</span><span class="nc">Error</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="nv">$instance</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
        <span class="k">clone</span> <span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>And here is the Singleton class code…</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//Singleton.php
<span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Com\Imdhemy</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Singleton</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var Singleton|null
     */</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">?Singleton</span> <span class="nv">$instance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="cd">/**
     * Singleton constructor
     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>

    <span class="cd">/**
     * Prevents Cloning
     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="n">__clone</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return Singleton
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getInstance</span><span class="p">():</span> <span class="kt">Singleton</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="nv">$instance</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">static</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">static</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="why-laravel-container-is-a-special-singleton-class">Why Laravel Container is a special singleton class</h2>
<p>If you checked the <a href="https://github.com/laravel/framework/blob/8.x/src/Illuminate/Foundation/Application.php#L29">Laravel source code</a>, you will find that the <code class="language-plaintext highlighter-rouge">Application</code> class extends the <code class="language-plaintext highlighter-rouge">Container</code> class. The latter is a special singleton implementation. It makes sense to have a single instance of the application within your application.</p>

<p>You can easily find the <code class="language-plaintext highlighter-rouge">getInstance</code> <a href="https://github.com/laravel/framework/blob/8.x/src/Illuminate/Container/Container.php#L1382-L1389">method on the Container class</a>, but if you checked the container constructor, you <strong>will not</strong> find a private constructor. This is why I’m saying that the Laravel Container is a special singleton. It’s implemented in a way that gains the pros of a Singleton and avoids the cons.</p>

<p>Laravel developers are smart enough to realize that <em>it’s completely fine to have a single object within your application, but it’s not fine to make it impossible to make a second instance</em>.</p>

<h2 id="a-single-instance-of-a-file-counts-as-a-singleton">A single instance of a file counts as a singleton</h2>

<p>The term Singleton comes from mathematics. In mathematics, a Singleton, also known as a unit set, is a set with exactly one element. For example, the set <code class="language-plaintext highlighter-rouge">{M}</code> is a singleton containing the element <code class="language-plaintext highlighter-rouge">M</code>.</p>

<p>Let’s imagine the situation when a particular part of your application code is manipulating the contents of a local file, and another part is updating the same file simultaneously! For instance, the first one is adding to the file, and the other one is removing lines from there! Definitely, this will result in inconsistent file contents.</p>

<p>As a solution, we need to ensure having a single instance of the file resource on our application during manipulation. Actually this is not a singleton class implementation, but it still implies the mathematics definition of a singleton.</p>

<p>The wonderful <a href="https://github.com/thephpleague/flysystem">Flysystem</a> PHP package provides one interface to interact with many types of filesystems.</p>

<p>Flysystem ships with a default adapter, which is the Local adapter. By default, this adapter <a href="https://github.com/thephpleague/flysystem/blob/2.x/src/Local/LocalFilesystemAdapter.php#L87">uses a lock</a> during writes and updates.</p>

<h2 id="summary">Summary</h2>

<p>Singleton is a creational design pattern, which ensures that only one object of its kind exists and provides a single point of access to it for any other code.</p>

<p>I’d prefer to assign the responsibility of ensuring having only one object to another Class or helper or at least do the same as Laravel developers did, and I’d also avoid hiding the constructor.</p>

<p>It’s completely fine to have a single object within your application, but it’s not fine to make it impossible to make a second instance.</p>

</div>


    </main>
    <section class="sticky top-[100vh]">
    <div class="p-10">
        <div class="max-w-screen-md mx-auto">
            <p class="text-center">
                <!-- 2001 - jekyll current year -->
                &copy; 2021 - 2024 . imdhemy.com Published by Jekyll, hosted on GitHub Pages.
            </p>
        </div>
    </div>
</section>

</div>


<!-- Ion icons -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

<!-- Main JS file -->
<script src="/assets/js/dist/main.js?v=1.0.0"></script>
</body>
</html>
