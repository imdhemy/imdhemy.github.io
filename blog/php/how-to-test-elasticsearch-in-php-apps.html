<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>How to test Elasticsearch in PHP applications | imdhemy</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="How to test Elasticsearch in PHP applications" />
<meta name="author" content="Mohamad Eldhemy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Currently, I’m working on the Elasticsearch PHP Sugar package. It’s a wrapper over the low-level Elasticsearch client that adds syntactic sugar for PHP developers. I’ll publish a blog post once I publish the first release." />
<meta property="og:description" content="Currently, I’m working on the Elasticsearch PHP Sugar package. It’s a wrapper over the low-level Elasticsearch client that adds syntactic sugar for PHP developers. I’ll publish a blog post once I publish the first release." />
<link rel="canonical" href="https://imdhemy.com/blog/php/how-to-test-elasticsearch-in-php-apps.html" />
<meta property="og:url" content="https://imdhemy.com/blog/php/how-to-test-elasticsearch-in-php-apps.html" />
<meta property="og:site_name" content="imdhemy" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-09T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How to test Elasticsearch in PHP applications" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Mohamad Eldhemy"},"dateModified":"2021-09-09T00:00:00+00:00","datePublished":"2021-09-09T00:00:00+00:00","description":"Currently, I’m working on the Elasticsearch PHP Sugar package. It’s a wrapper over the low-level Elasticsearch client that adds syntactic sugar for PHP developers. I’ll publish a blog post once I publish the first release.","headline":"How to test Elasticsearch in PHP applications","mainEntityOfPage":{"@type":"WebPage","@id":"https://imdhemy.com/blog/php/how-to-test-elasticsearch-in-php-apps.html"},"url":"https://imdhemy.com/blog/php/how-to-test-elasticsearch-in-php-apps.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css?t=2022-08-14-10-02"><link type="application/atom+xml" rel="alternate" href="https://imdhemy.com/feed.xml" title="imdhemy" /></head>
<body><div class="container mx-auto pt-7 pb-7">
    <header class="flex flex-row">
        <!-- Brand start-->
        <div class="p-5">
            <a href="/" class="flex justify-start items-center mr-3 hover:no-underline block">
                <img class="w-5 h-5 lg:w-10 lg:h-10" src="/logo.png" alt="imdhemy">
                <span class="font-bold text-xl lg:text-4xl text-black font-sans">imdhemy</span>
            </a>
        </div>
        <!-- Brand End -->

        <!-- Mobile Navigation Start -->
        <div class="flex-auto flex justify-end p-5 lg:hidden">
            <button id="nav-controller" class="focus:outline-none block">
                <ion-icon class="text-4xl w-10 h-10 p-0 m-0" name="menu-outline"></ion-icon>
            </button>
            <div id="mobile-nav-menu" class="fixed bg-white right-0 bottom-0 left-0 hidden">
                <div class="flex h-full justify-center p-10">
                    <ul class="flex flex-col justify-center text-left p-0 m-0">
                        
                        
                        <li class="text-3xl font-light mobile-nav-link-item"><a href="/">Home</a></li>
                        
                        
                        
                        <li class="text-3xl font-light mobile-nav-link-item"><a href="/blog">Blog</a></li>
                        
                        
                        
                        <li class="text-3xl font-light mobile-nav-link-item"><a href="/about">About</a></li>
                        
                        
                    </ul>
                </div>
            </div>
        </div>
        <!-- Mobile Navigation End -->

        <!-- Desktop Navigation Start -->
        <div class="hidden lg:block flex-auto flex p-5">
            
            
            <ul class="flex justify-end text-left p-0 m-0">
                
                
                
                
                <li class="text-xl font-light mobile-nav-link-item nav-item"><a href="/">Home</a></li>
                
                
                
                
                
                
                <li class="text-xl font-light mobile-nav-link-item nav-item nav-item-active"><a href="/blog">Blog</a></li>
                
                
                
                
                
                
                <li class="text-xl font-light mobile-nav-link-item nav-item"><a href="/about">About</a></li>
                
                
                
            </ul>
        </div>
        <!-- Desktop Navigation End -->
    </header>
</div>
<main class="container mx-auto lg:w-2/3" aria-label="Content">
    <header class="container mx-auto p-5 text-center">
    <h1 class="post-title p-name" itemprop="name headline">How to test Elasticsearch in PHP applications</h1>
    <p class="post-meta">
        <time class="dt-published" datetime="2021-09-09T00:00:00+00:00" itemprop="datePublished">Sep 9, 2021
        </time>
        
        • <span>php</span>
        
    </p>
</header>

<article class="bg-white rounded-lg filter drop-shadow-md lg:ml-0 lg:mr-0 ml-5 mr-5 mb-20" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="p-5 post-content" itemprop="articleBody">
        <p>Currently, I’m working on the <a href="https://github.com/imdhemy/elasticsearch-php-sugar">Elasticsearch PHP Sugar package</a>. It’s a wrapper over the low-level Elasticsearch client that adds <a href="https://en.wikipedia.org/wiki/Syntactic_sugar">syntactic sugar</a> for PHP developers. I’ll publish a blog post once I publish the first release.</p>

<p>One of the interesting things I have to work on is testing Elasticsearch in PHP. When unit-testing an external service, you often need to simulate specific scenarios like returning a successful response, returning an error, or returning particular responses in a certain order. In this blog post, I will show you how to add unit tests and integration tests for Elasticsearch in your PHP application. Let’s start with a short note about the Practical Test Pyramid.</p>

<h3 id="practical-test-pyramid">Practical Test Pyramid</h3>
<p><img src="/assets/img/test-pyramid.png" alt="Test Pyramid" /></p>

<p>In his book <a href="https://www.goodreads.com/book/show/6707987-succeeding-with-agile"><em>Succeeding With Agile</em></a><em>,</em> Mike Cohn came up with the Test Pyramid concept. Test Pyramid tells you to think about different layers of testing. It also tells you how much testing to do on each layer. It consists of three layers from the bottom up:</p>

<ul>
  <li>Unit Tests.</li>
  <li>Service Tests.</li>
  <li>UI Tests.</li>
</ul>

<p>The names introduced by Mike Cohn are confusing, at least for me. I’ll go for different naming for each testing layer:</p>

<ul>
  <li>Unit Tests. It’s the same 😅</li>
  <li>Integration Tests.</li>
  <li>End to End Tests.</li>
</ul>

<p>As a rule of thumb, stick to the pyramid shape to come up with a healthy, fast, and maintainable test suite. Below is a list of tips to follow:</p>

<ol>
  <li>Write tests with different granularity</li>
  <li>The more high-level you get the fewer tests you should have</li>
  <li>Write <em>lots</em> of small and fast <em>unit tests</em>.</li>
  <li>Write <em>some</em> more coarse-grained tests.</li>
  <li>Write <em>very few</em> high-level tests that test your application from end to end.</li>
</ol>

<p>In this blog post, I will cover only the first two types of the Test Pyramid. Unit and Integration Tests.</p>

<h3 id="how-to-unit-test-elasticsearch-in-php">How to Unit Test Elasticsearch in PHP</h3>

<p>Unit tests <a href="https://github.com/elastic/elasticsearch-php/pull/618#issuecomment-323816444">shouldn’t depend on a running cluster</a>, should be mocked out instead. To be more specific the client response should be mocked.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">GuzzleHttp\Ring\Client\MockHandler</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Elasticsearch\ClientBuilder</span><span class="p">;</span>

<span class="c1">// The connection class requires 'body' to be a file stream handle</span>
<span class="c1">// Depending on what kind of request you do, you may need to set more values here</span>
<span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockHandler</span><span class="p">([</span>
  <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span>
  <span class="s1">'transfer_stats'</span> <span class="o">=&gt;</span> <span class="p">[</span>
     <span class="s1">'total_time'</span> <span class="o">=&gt;</span> <span class="mi">100</span>
  <span class="p">],</span>
  <span class="s1">'body'</span> <span class="o">=&gt;</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'somefile.json'</span><span class="p">),</span>
  <span class="s1">'effective_url'</span> <span class="o">=&gt;</span> <span class="s1">'localhost'</span>
<span class="p">]);</span>
<span class="nv">$builder</span> <span class="o">=</span> <span class="nc">ClientBuilder</span><span class="o">::</span><span class="nf">create</span><span class="p">();</span>
<span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">setHosts</span><span class="p">([</span><span class="s1">'somehost'</span><span class="p">]);</span>
<span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">setHandler</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">build</span><span class="p">();</span>
<span class="c1">// Do a request and you'll get back the 'body' response above</span>
</code></pre></div></div>

<p>The previous example is provided by the official package maintainers. Besides, I don’t like the idea of using JSON files, we may need to override some values or options during the runtime. This is why I created <a href="https://github.com/imdhemy/testing-es-in-php/tree/master/tests/Utils">these Utils</a> to be used as follows:</p>

<hr />
<p><strong>[UPDATE: 5 November 2021: 02:21 PM]</strong>
I published a PHP package with enhanced <a href="https://github.com/imdhemy/es-testing-utils">Utils to test Elasticsearch</a>. You can use composer to install it.</p>

<hr />

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$handler</span> <span class="o">=</span> <span class="nc">MockHandler</span><span class="o">::</span><span class="nf">_mockTemplate_</span><span class="p">(</span><span class="s1">'index_document'</span><span class="p">);</span>
</code></pre></div></div>

<p>Just provide the template name to the <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Utils/MockHandler.php#L45">static method</a>, and it will do the rest for you. <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/fixtures/responses/index_document.php">The template</a> is a PHP file that returns an array representing the expected client response.</p>

<p><strong>Here is an example of a unit test</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ElasticSearchEngineTest</span> <span class="kd">extends</span> <span class="nc">UnitTestCase</span>
<span class="p">{</span>
    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">test_it_can_index_a_document</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$handler</span> <span class="o">=</span> <span class="nc">MockHandler</span><span class="o">::</span><span class="nf">mockTemplate</span><span class="p">(</span><span class="s1">'index_document'</span><span class="p">);</span>

        <span class="nv">$builder</span> <span class="o">=</span> <span class="nc">ClientBuilder</span><span class="o">::</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">setHandler</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>
        <span class="nv">$client</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">build</span><span class="p">();</span>


        <span class="nv">$elasticSearchEngine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ElasticSearchEngine</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
        <span class="nv">$document</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'author'</span> <span class="o">=&gt;</span> <span class="s1">'Albert Einstein'</span><span class="p">,</span>
            <span class="s1">'quote'</span> <span class="o">=&gt;</span> <span class="s1">'I have no special talents. I am only passionately curious.'</span><span class="p">,</span>
        <span class="p">];</span>

        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$elasticSearchEngine</span><span class="o">-&gt;</span><span class="nf">index</span><span class="p">(</span><span class="s1">'quotes_index'</span><span class="p">,</span> <span class="nv">$document</span><span class="p">);</span>

        <span class="nv">$expectedResponse</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getTemplate</span><span class="p">(</span><span class="s1">'index_document'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$expectedResponse</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As simple as that 🚀</p>

<h3 id="how-to-add-integration-tests-to-elasticsearch-in-php">How to add Integration Tests to Elasticsearch in PHP</h3>

<p>For this part, you don’t just need to run your application but also the component you’re integrating with, Elasticsearch in our case. To automate this process I’m going to use <a href="https://circleci.com/">CircleCI</a>. CircleCI integrates with GitHub and Bitbucket, in our example project we will use Github, but you can do the same on Bitbucket.</p>

<p>Let’s create our configuration file. Don’t be worry if you didn’t use CircleCI before, all you need is to understand the following YAML file.</p>

<p>on <code class="language-plaintext highlighter-rouge">.circleci/config.yml</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># PHP8.0 &amp; ES7.14.0 CircleCI 2.0 configuration file</span>
<span class="c1">#</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/php:8.0.10-cli</span> <span class="c1">#1</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.14.0</span> <span class="c1">#2</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="c1">#3</span>
          <span class="pi">-</span> <span class="na">transport.host</span><span class="pi">:</span> <span class="s">localhost</span>
          <span class="pi">-</span> <span class="na">network.host</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
          <span class="pi">-</span> <span class="na">http.port</span><span class="pi">:</span> <span class="m">9200</span>
          <span class="pi">-</span> <span class="na">cluster.name</span><span class="pi">:</span> <span class="s">es-cluster</span>
          <span class="pi">-</span> <span class="na">discovery.type</span><span class="pi">:</span> <span class="s">single-node</span>
          <span class="pi">-</span> <span class="na">xpack.security.enabled</span><span class="pi">:</span> <span class="no">false</span>
          <span class="pi">-</span> <span class="na">ES_JAVA_OPTS</span><span class="pi">:</span> <span class="s2">"</span><span class="s">-Xms256m</span><span class="nv"> </span><span class="s">-Xmx256m"</span>
    <span class="na">steps</span><span class="pi">:</span> <span class="c1">#4</span>
      <span class="pi">-</span> <span class="s">checkout</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">sudo apt update</span>

      <span class="c1"># Download and cache dependencies</span>
      <span class="pi">-</span> <span class="na">restore_cache</span><span class="pi">:</span>
          <span class="na">keys</span><span class="pi">:</span>
            <span class="c1"># "composer.lock" can be used if it is committed to the repo</span>
            <span class="pi">-</span> <span class="s">v1-dependencies-{{ checksum "composer.json" }}</span>
            <span class="c1"># fallback to using the latest cache if no exact match is found</span>
            <span class="pi">-</span> <span class="s">v1-dependencies-</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">composer install -n --prefer-dist</span>

      <span class="c1"># Wait for ES startup</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="c1">#5</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Waiting for Elasticsearch</span>
          <span class="na">command</span><span class="pi">:</span> <span class="s">dockerize --wait http://localhost:9200 -timeout 1m</span>
      <span class="c1"># run tests with phpunit</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">composer test</span> <span class="c1">#6</span>

</code></pre></div></div>

<p>I’m using docker images to build my application, <code class="language-plaintext highlighter-rouge">#1</code> for <strong>PHP8.0</strong> and <code class="language-plaintext highlighter-rouge">#2</code> for the <strong>Elasticsearch</strong> prebuild image. CircleCI provides other ways to start your machine, but docker 🐳 is super easy to use.</p>

<p><code class="language-plaintext highlighter-rouge">#3</code> is the environment variables used for Elasticsearch configuration.</p>

<p>Number <code class="language-plaintext highlighter-rouge">#4</code> shows the build job steps, but give more attention to <code class="language-plaintext highlighter-rouge">#5</code> which allows our test suites to wait for Elasticsearch to be ready. Finally, on <code class="language-plaintext highlighter-rouge">#6</code> we are using composer to run PHPUnit Tests.</p>

<p><strong>Let’s add the first integration test.</strong> For your local development, you can depend on the docker-compose to start Elasticsearch.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up -d
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SearchEngineTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">test_get_client_info</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$client</span> <span class="o">=</span> <span class="nc">ClientBuilder</span><span class="o">::</span><span class="nf">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">build</span><span class="p">();</span>
        <span class="nv">$searchEngine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ElasticSearchEngine</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
        <span class="nv">$info</span> <span class="o">=</span> <span class="nv">$searchEngine</span><span class="o">-&gt;</span><span class="nf">info</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertArrayHasKey</span><span class="p">(</span><span class="s1">'tagline'</span><span class="p">,</span> <span class="nv">$info</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'You Know, for Search'</span><span class="p">,</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'tagline'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
<p><strong>Final steps:</strong></p>

<p><img src="/assets/img/circle-ci-es-php-app.png" alt="CircleCi Dashboard" /></p>

<ul>
  <li>Push your code to GitHub.</li>
  <li><a href="https://app.circleci.com/">Give CircleCI access</a> to this repository.</li>
  <li>And watch your integration tests running. 🚀 🔥</li>
</ul>

<h3 id="summary">Summary</h3>

<p>I have created a <a href="https://github.com/imdhemy/testing-es-in-php">repository of an example application</a>. You can clone it and start playing with code. It requires PHP.8 installed on your host machine. If you prefer PHP7, you can checkout to PHP7.3 branch.</p>

<p>It would be better if completed the exercises I added for you.</p>

<ul>
  <li>Exercise No.1: <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Unit/ElasticSearchEngineTest.php#L39">Add a unit test for search by a keyword.</a></li>
  <li>Exercise No.2: <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Integration/SearchEngineTest.php#L26">Add an integration test for indexing a document.</a></li>
  <li>Exercise No.3: <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Integration/SearchEngineTest.php#L35">Add an integration test for searching for a keyword.</a></li>
</ul>

<p>Feel free to make a PR of your answers.</p>


    </div><a class="u-url" href="/blog/php/how-to-test-elasticsearch-in-php-apps.html" hidden></a>

    <div class="lg:flex bg-sky-100 border-t-2 border-sky-300 justify-between p-4 text-lg rounded-br-lg rounded-bl-lg">
        <div class="flex flex-col justify-center mb-4 lg:mb-0">
            
           <div class="text-center">
               <p class="uppercase">Previous Post</p>
               <a href="/blog/php/why-you-need-a-builder-to-create-your-entities-and-models.html">&larr;Why you need a builder to create your entities and models</a>
           </div>
            
        </div>

        <div class="flex flex-col justify-center">
            
            <div class="text-center">
                <p class="uppercase">Next Post</p>
                <a class="next" href="/blog/php/real-world-use-cases-of-sinlgeton-in-php.html">PHP Real-world use cases of singleton design pattern&rarr;</a>
            </div>
            
        </div>

    </div>
</article>

</main><footer class="bg-white">
    <div class="container mx-auto lg:p-0 p-5">
        <div class="flex flex-col justify-center pt-10 pb-10 text-lg">
            <div class="flex-1 text-center">
                <p>Let's get together</p>
                <ul class="footer-social-links p-0 m-0">
                    
                    <li class="inline"><a href="https://twitter.com/imdhemy">Twitter</a></li>
                    
                    <li class="inline"><a href="https://github.com/imdhemy">Github</a></li>
                    
                    <li class="inline"><a href="https://linkedin.com/in/imdhemy">Linkedin</a></li>
                    
                </ul>
            </div>

            <div class="flex-1 text-center mt-10">
                <p>&copy; 2021 - 2022 imdhemy.com</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script>

<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://imdhemy.com/assets/js/script.js?v=2022-08-14-10-02"></script>
</body>

</html>
