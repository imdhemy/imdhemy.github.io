<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Building a Robust Movie Recommender Using KoalaTs and MongoDB - Part 1 üê® üé¨</title>
    <meta name="description"
          content="Last week, I wanted to try out KoalaTs in a real-world project to see how it would perform, and to get some insights into what should be the next improvement...">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Display:ital,wght@0,100..900;1,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">

    <link rel="canonical" href="https://imdhemy.com/blog/nodejs/robust-movie-recommender-koalats-mongodb-part-1.html/">
    <link rel="stylesheet" href="/assets/css/main.css?v=1.0.0">
    
    <link rel="icon" type="image/png" href="/assets/theme/favicon.png">
    
    

    
    <!-- Facebook Meta Tags -->
<meta property="og:title" content="Building a Robust Movie Recommender Using KoalaTs and MongoDB - Part 1 üê® üé¨">
<meta property="og:type" content="article">
<meta property="og:image" content="https://imdhemy.com/assets/img/koala.jpg">
<meta property="og:url" content="https://imdhemy.com/blog/nodejs/robust-movie-recommender-koalats-mongodb-part-1.html/">
<meta property="og:description"
      content="Last week, I wanted to try out KoalaTs in a real-world project to see how it would perform, and to get some insights into what should be the next improvement...">
<meta property="og:site_name" content="Imdhemy">

<!-- Twitter Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Building a Robust Movie Recommender Using KoalaTs and MongoDB - Part 1 üê® üé¨">
<meta name="twitter:description"
      content="Last week, I wanted to try out KoalaTs in a real-world project to see how it would perform, and to get some insights into what should be the next improvement...">
<meta name="twitter:image" content="https://imdhemy.com/assets/img/koala.jpg">


    

</head>
<body class="min-h-screen">
<div class="min-h-screen">
    <header class="relative" id="main-header">
    <div class="container mx-auto">
        <div class="flex py-6 lg:py-14 p-5 lg:px-0">
            <!-- begin logo -->
            <div class="flex-auto">
                <div>
                    <a href="/" class="text-gray-900 text-3xl font-bold">
                        Imdhemy
                    </a>
                </div>
            </div>
            <!-- end logo -->
            <!-- begin right part -->
            <div class="flex-auto">
                <div class="flex justify-end lg:hidden">
                    <button type="button" class="menu-toggle" data-target="#mobile-nav">
                        <ion-icon name="menu-outline"></ion-icon>
                    </button>
                </div>

                <div class="hidden lg:flex justify-end">
                    <ul class="flex items-center">
                        
                        <li class="ml-10">
                            <a href="/"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Home
                            </a>
                        </li>
                        
                        <li class="ml-10">
                            <a href="/blog"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Blog
                            </a>
                        </li>
                        
                        <li class="ml-10">
                            <a href="/about"
                               class="text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                About
                            </a>
                        </li>
                        
                    </ul>
                </div>
                <!-- end right part -->
            </div>
            <!-- begin mobile nav -->
            <nav id="mobile-nav"
                 class="menu -z-10 opacity-0 absolute top-32 right-6 block min-w-fit w-40 bg-white p-5 rounded-md shadow-md ease-linear">
                <div class="ml-auto">
                    <ul class="p-0 m-0 flex-column items-center">
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Home
                            </a>
                        </li>
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/blog"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                Blog
                            </a>
                        </li>
                        
                        <li class="block flex-1 w-full m-0">
                            <a href="/about"
                               class="block text-right text-base font-semibold p-2 text-gray-900 ease-linear hover:text-blue-600 active:text-blue-600">
                                About
                            </a>
                        </li>
                        
                    </ul>
                </div>
            </nav>
            <!-- end mobile nav -->
        </div>
    </div>
</header>

    <main>
        <div class="max-w-screen-md mx-auto bg-white p-5">
    <h1 class="font-black font-sans text-2xl lg:text-4xl post-title">Building a Robust Movie Recommender Using KoalaTs and MongoDB - Part 1 üê® üé¨</h1>
</div>

<div class="max-w-screen-md mx-auto bg-white p-5">
    <div class="flex justify-between flex-wrap my-2">
        <div class="flex items-center mr-8">
            <img src="/theme/images/avatar.jpeg" alt=""
                 class="rounded-full w-10 h-10 mr-3 block"/>
            <div>
                <p class="text-gray-700 text-sm font-bold">Dhemy</p>
                <p class="text-gray-500 text-xs">
                    January 18, 2025 - 9 min read
                </p>
            </div>
        </div>
    </div>

    <div>
        
        <div class="flex mb-5">
    
</div>

    </div>

    
    <div class="relative overflow-hidden">
        <img src="/assets/img/koala.jpg"
             alt="A sleeping koala"
             class="w-full h-auto rounded"/>
        <!-- Image source -->
        
        <div class="bg-white text-xs text-gray-500 px-2 py-1">
            Image source: https://unsplash.com/photos/koala-sleeping-on-tree-branch-EerxztHCjM8
        </div>
        
    </div>
    
</div>


<div class="m-auto max-w-screen-md bg-white p-5 text-xl content">
    <p>Last week, I wanted to try out KoalaTs in a real-world project to see how it would perform, and to get some insights
into what should be the next improvement. I decided to build a simple movie recommender
using <a href="https://koala-ts.github.io/docs/">KoalaTs</a> and MongoDB. Once,
I had the simple version working, I decided to dive deeper into the project and make it more powerful and robust.</p>

<p>Today, I will show you the simple version of the movie recommender, <del>and next week, I will discuss how to make it more powerful</del>. You can find the code for this project on my <a href="https://github.com/imdhemy/koala-recommender">GitHub repository</a>. Let‚Äôs get started!</p>

<h2 id="overview">Overview</h2>

<p>The basic idea is to store the movies into a MongoDB database and get advantage of MongoDB Atlas search <code class="language-plaintext highlighter-rouge">moreLikeThis</code>
query to get similar movies. The better movie attributes you have, the better recommendations you will get.
Needless to say that the amount of data also plays a big role in the quality of the recommendations.</p>

<h2 id="project-setup">Project setup</h2>

<p>First, you need to create a new KoalaTs project. You can do this by running the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx @koala-ts/cli create koala-recommender
</code></pre></div></div>

<p>Then, we need to dockerize the project to make it easier to run. You can find
the <a href="https://github.com/imdhemy/koala-recommender/blob/main/Dockerfile">Dockerfile</a>
and <a href="https://github.com/imdhemy/koala-recommender/blob/main/docker-compose.yml">docker-compose.yml</a> in
the GitHub repository.</p>

<h2 id="mongodb-setup">MongoDB setup</h2>

<p>We are using the <code class="language-plaintext highlighter-rouge">mongodb/mongodb-atlas-local:8</code> image to run a local MongoDB Atlas instance. Unfortunately, seeding the
search index with the container startup is not supported yet. So, we need to do it ourselves. You can do this manually
if you are running MongoDB Compass. I have created a script to do this for my unit tests.</p>

<p>KoalaTs comes with <a href="https://vitest.dev/">Vitest</a> by default, which we will use to write out unit tests. You still can
use any other testing library you like, but KoalaTs is built with Vitest in mind, because everyone should! üòÑ</p>

<p>The script is located in
the <a href="https://github.com/imdhemy/koala-recommender/blob/0b6903e7c79baef6143bffef19e1f806eced7f78/tests/_setup/global.ts#L14-L28">tests/_setup/global.ts</a></p>

<p>The basic idea is to create a <code class="language-plaintext highlighter-rouge">movies</code> collection and insert a temporary document, then create a search index with a
dynamic mapping, and finally delete the temporary document. The temporary document is not necessary, but it helped to
debug the search index creation.</p>

<p>Talking about testing is beyond the scope of this article, but you can find the tests in the GitHub repository.</p>

<h2 id="connecting-to-mongodb">Connecting to MongoDB</h2>

<p>KoalaTs is a database-agnostic, but it recommends using the native MongoDB driver. I used the powerful KoalaTs <code class="language-plaintext highlighter-rouge">.env</code>
configuration files to store the MongoDB connection string.</p>

<p>Let‚Äôs install the MongoDB driver:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>mongodb
</code></pre></div></div>

<p>Then update our environment variables:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># .env
MONGODB_URI=mongodb://mongod:27017?directConnection=true
MONGODB_DB=koala
</code></pre></div></div>

<p>And for testing, I used a different database:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># .env.test
MONGODB_URI=mongodb://mongod:27017?directConnection=true
MONGODB_DB=koala_test
</code></pre></div></div>

<p>Now, we can connect to MongoDB using the following code:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">Db</span><span class="p">,</span> <span class="nx">MongoClient</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">mongodb</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="kd">as </span><span class="nx">process</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">node:process</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">let</span> <span class="nx">db</span><span class="p">:</span> <span class="nx">Db</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">let</span> <span class="nx">client</span><span class="p">:</span> <span class="nx">MongoClient</span><span class="p">;</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">connectToDb</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// I used here the `process.env` to get the environment variables directly</span>
    <span class="c1">// but as a best practice, you should extract them to a configuration file under the `/src/config` directory</span>
    <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MongoClient</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_URI</span> <span class="kd">as </span><span class="kr">string</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nf">connect</span><span class="p">();</span>
    <span class="nx">db</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">db</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_DB</span> <span class="kd">as </span><span class="kr">string</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code will connect to the MongoDB instance and monkey-patch the <code class="language-plaintext highlighter-rouge">db</code> and <code class="language-plaintext highlighter-rouge">client</code> variables to be used in other
parts of the application. We need to call this function in the <code class="language-plaintext highlighter-rouge">index.ts</code> file before starting the server, to ensure
that the database connection is established only once.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// src/index.ts
<span class="err">
</span><span class="p">import {create} from '@koala-ts/framework';
import {appConfig} from './config/app';
</span><span class="gi">+ import {connectToDb} from './infrastructure/database';
</span><span class="err">
</span><span class="p">const app = create(appConfig);
</span><span class="err">
</span>// The top-level await works like a charm because KoalaTs was built with ES modules in mind
<span class="gi">+ await connectToDb();
</span><span class="p">app.listen(3000);
</span><span class="err">
</span><span class="p">console.log('Server is running on http://localhost:3000');
</span></code></pre></div></div>

<h2 id="the-movie-document">The Movie document</h2>

<p>As mentioned earlier, I started with a simple version, but once again, the better the attributes, the better the
recommendations. Here is an example of a movie document:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"$oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6786c3566e2c67647853df7d"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The Godfather"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"genre"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"Crime"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Drama"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Thriller"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"plot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The aging patriarch of an organized crime dynasty transfers control of his clandestine empire to his reluctant son."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"releaseDate"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1972-03-24T00:00:00.000Z"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="creating-the-movie-endpoint">Creating the movie endpoint</h2>

<p>We need to create an endpoint to add a movie to the database. We will use the <code class="language-plaintext highlighter-rouge">POST</code> method to create a new movie. This
can be done by creating a new controller under the <code class="language-plaintext highlighter-rouge">src/controllers</code> directory.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// src/controllers/MovieController.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="kd">type</span> <span class="nx">IScope</span><span class="p">,</span> <span class="nx">Route</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@koala-ts/framework</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nc">MovieController</span> <span class="p">{</span>
    <span class="p">@</span><span class="nd">Route</span><span class="p">({</span><span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/movies</span><span class="dl">'</span><span class="p">})</span>
    <span class="k">async</span> <span class="nf">store</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">IScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span> <span class="c1">// Added for now, because the default is 404!</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Don‚Äôt forget to add the controller to the <code class="language-plaintext highlighter-rouge">controllers</code> array in the <code class="language-plaintext highlighter-rouge">src/config/app.ts</code> file.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// src/config/app.ts
<span class="p">import { HomeController } from '../controller/HomeController';
import { type IKoalaConfig } from '@koala-ts/framework';
</span><span class="gi">+import { MovieController } from '../controller/MovieController';
</span><span class="err">
</span><span class="p">export const appConfig: IKoalaConfig = {
</span>    controllers: [
        HomeController,
<span class="gi">+       MovieController,
</span>    ]
};
</code></pre></div></div>

<p>Then we need to implement the <code class="language-plaintext highlighter-rouge">createMovie</code> service. This service will be responsible for creating a new movie in the
database.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// src/application/movie/creat-movie.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IMovie</span><span class="p">,</span> <span class="nx">IMovieProps</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./types</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">db</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../infrastructure/database</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">createMovie</span><span class="p">(</span><span class="nx">props</span><span class="p">:</span> <span class="nx">IMovieProps</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">IMovie</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="na">doc</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">IMovie</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{...</span><span class="nx">props</span><span class="p">,</span> <span class="na">releaseDate</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">releaseDate</span><span class="p">)};</span>

    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">movies</span><span class="dl">'</span><span class="p">).</span><span class="nf">insertOne</span><span class="p">({...</span><span class="nx">doc</span><span class="p">});</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">insertedId</span><span class="p">.</span><span class="nf">toString</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">doc</span> <span class="kd">as </span><span class="nx">IMovie</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then we need to call this service in the controller:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// src/controllers/MovieController.ts
<span class="p">import { type IScope, Route } from '@koala-ts/framework';
</span><span class="gi">+ import { createMovie, IMovieProps } from '../application/movie';
</span><span class="err">
</span><span class="p">export class MovieController {
</span>    @Route({ method: 'POST', path: '/movies' })
    async store(scope: IScope) {
<span class="gi">+        scope.response.body = await createMovie(scope.request.body as IMovieProps);
</span>         scope.response.status = 201;
    }
}
</code></pre></div></div>

<h2 id="recommendations">Recommendations</h2>

<p>Now, the time has come to get the recommendations. We will create a new endpoint to get the recommendations for a movie.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// src/controllers/MovieController.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="kd">type</span> <span class="nx">IScope</span><span class="p">,</span> <span class="nx">Route</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@koala-ts/framework</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">createMovie</span><span class="p">,</span> <span class="nx">IMovieProps</span><span class="p">,</span> <span class="nx">recommendMovie</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../application/movie</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nc">MovieController</span> <span class="p">{</span>
    <span class="p">@</span><span class="nd">Route</span><span class="p">({</span><span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/movies</span><span class="dl">'</span><span class="p">})</span>
    <span class="k">async</span> <span class="nf">store</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">IScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">createMovie</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span> <span class="kd">as </span><span class="nx">IMovieProps</span><span class="p">);</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Route</span><span class="p">({</span><span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/movies:recommend</span><span class="dl">'</span><span class="p">})</span>
    <span class="k">async</span> <span class="nf">recommend</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">IScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">recommendMovie</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span> <span class="kd">as </span><span class="nx">IMovieProps</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">recommendMovie</code> function will receive a movie object and return the top 5 recommended movies. Here is the code for
the service:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// src/application/movie/recommend-movie.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IMovie</span><span class="p">,</span> <span class="nx">IMovieProps</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./types</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">db</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../infrastructure/database</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">recommendMovie</span><span class="p">(</span><span class="nx">props</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">IMovieProps</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">IMovie</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">movies</span><span class="dl">'</span><span class="p">).</span><span class="nf">aggregate</span><span class="p">([</span>
        <span class="p">{</span><span class="na">$search</span><span class="p">:</span> <span class="p">{</span><span class="na">moreLikeThis</span><span class="p">:</span> <span class="p">{</span><span class="na">like</span><span class="p">:</span> <span class="nx">props</span><span class="p">}}},</span>
        <span class="p">{</span><span class="na">$limit</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
        <span class="p">{</span><span class="na">$addFields</span><span class="p">:</span> <span class="p">{</span><span class="na">score</span><span class="p">:</span> <span class="p">{</span><span class="na">$meta</span><span class="p">:</span> <span class="dl">'</span><span class="s1">searchScore</span><span class="dl">'</span><span class="p">}}}</span>
    <span class="p">]);</span>

    <span class="kd">const</span> <span class="na">result</span><span class="p">:</span> <span class="nx">IMovie</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="k">await </span><span class="p">(</span><span class="kd">const</span> <span class="nx">movie</span> <span class="k">of</span> <span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">({...</span><span class="nx">movie</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">movie</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nf">toString</span><span class="p">()}</span> <span class="kd">as </span><span class="nx">IMovie</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="takeaways">Takeaways</h2>

<h3 id="mongodb-atlas-search">MongoDB Atlas Search</h3>

<p>MongoDB Atlas is using Lucene under the hood to provide the search capabilities. The <code class="language-plaintext highlighter-rouge">moreLikeThis</code> query to work, you
need to seed the Database with many documents, in other words, if you tried recommending a movie with only one or two
movies most likely you will get no results.</p>

<h3 id="koalats">KoalaTs</h3>

<p>While building this project, I was impressed myself with how easy it was to build a REST API using KoalaTs. There is
always room for improvement, and below is a list of things I will improve in KoalaTs:</p>

<ul>
  <li><a href="https://github.com/koala-ts/cli/issues/10">Add templates for vitest setup files in the generated project.</a></li>
  <li><a href="https://github.com/koala-ts/cli/issues/11">Improve Typescript configuration</a>.</li>
  <li><a href="https://github.com/koala-ts/cli/issues/12">Add the <code class="language-plaintext highlighter-rouge">PORT</code> environment variable to the generated project</a>.</li>
</ul>

<h3 id="next-steps">Next steps</h3>

<p><del>In the next article, I will discuss how to make the movie recommender more powerful, stay tuned! Let the KoalaTs be with
you! üê®</del></p>

<p>Even though I won‚Äôt publish a second article, the path to improving the movie recommender is clear: the richer your movie attributes, the better the recommendations you‚Äôll get. Enhancing the documents with extra metadata like cast, director, language, country, keywords, runtime, or even ratings will make the <code class="language-plaintext highlighter-rouge">moreLikeThis</code> query far more effective. So, if you want better results, feed your database with real-world movie data that‚Äôs as complete as possible.</p>

<p>Let the KoalaTs be with you! üê®</p>

</div>


    </main>
    <section class="sticky top-[100vh]">
    <div class="p-10">
        <div class="max-w-screen-md mx-auto">
            <p class="text-center">
                <!-- 2001 - jekyll current year -->
                &copy; 2021 - 2025 . imdhemy.com Published by Jekyll, hosted on GitHub Pages.
            </p>
        </div>
    </div>
</section>

</div>


<!-- Ion icons -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

<!-- Main JS file -->
<script src="/assets/js/dist/main.js?v=1.0.0"></script>
</body>
</html>
