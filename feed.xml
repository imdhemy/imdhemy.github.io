<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://imdhemy.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://imdhemy.com/" rel="alternate" type="text/html" /><updated>2023-04-16T17:24:35+00:00</updated><id>https://imdhemy.com/feed.xml</id><title type="html">Imdhemy</title><subtitle>I&apos;m a software artist, fullstack (BE heavy) with 10+ years of experience in software development. 
Passionate about open source, blogging, and reading.
</subtitle><author><name>Dhemy</name></author><entry><title type="html">Hidden Gems in Composer Every PHP Developer Should Know</title><link href="https://imdhemy.com/blog/php/hidden-gems-in-composer.html" rel="alternate" type="text/html" title="Hidden Gems in Composer Every PHP Developer Should Know" /><published>2023-04-16T00:00:00+00:00</published><updated>2023-04-16T00:00:00+00:00</updated><id>https://imdhemy.com/blog/php/hidden-gems-in-composer</id><content type="html" xml:base="https://imdhemy.com/blog/php/hidden-gems-in-composer.html"><![CDATA[<p><small>Photo by <a href="https://unsplash.com/@dtopkin1">Dayne Topkin</a> on <a href="https://unsplash.com">Unsplash</a></small></p>

<p>Composer is the most popular PHP dependency manager. I’ve heard about other package managers like <code class="language-plaintext highlighter-rouge">PEAR</code> &amp; <code class="language-plaintext highlighter-rouge">Phing</code>, but
I’ve never used them. While many developers are familiar with basic Composer commands like <code class="language-plaintext highlighter-rouge">install</code>, <code class="language-plaintext highlighter-rouge">update</code>,
and <code class="language-plaintext highlighter-rouge">require</code>, there are several hidden gems in Composer that can make maintaining your dependencies easier. In this
blog post, We’ll explore some of these hidden gems.</p>

<h2 id="1-composer-bump--composer-audit">1. composer bump &amp; composer audit</h2>

<p>Composer 4.2 added two new commands <code class="language-plaintext highlighter-rouge">composer bump</code> and <code class="language-plaintext highlighter-rouge">composer audit</code>.</p>

<p><code class="language-plaintext highlighter-rouge">composer bump</code> “bumps” the package version constraints listed in the composer.json file by increasing them to the
latest version within the allowed constraints.</p>

<p><code class="language-plaintext highlighter-rouge">composer audit</code>, scans the installed packages for reported security vulnerabilities. It exists with an error code if
there are any packages installed with known security vulnerabilities.</p>

<p>You can read more about them in the official <a href="https://php.watch/articles/composer-24">blog post</a>.</p>

<h2 id="2-composer-outdated">2. composer outdated</h2>

<p>Keeping your dependencies up-to-date is important for security and compatibility reasons. However, it can be
time-consuming to manually check for updates to each package in your project. This is where <code class="language-plaintext highlighter-rouge">composer outdated</code> comes
in. This command lists all the packages that have newer versions available, this comes with a color legend to help you
determine which packages are recommended to update or just possible to update.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer outdated
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Color legend:
- patch or minor release available - update recommended
- major release available - update possible

Direct dependencies required <span class="k">in </span>composer.json:
blackfire/php-sdk                  v1.33.0            v1.35.0            Blackfire.io PHP SDK
doctrine/annotations               1.14.3             2.0.1              Docblock Annotations Parser

... Other packages are omitted <span class="k">for </span>brevity ...

</code></pre></div></div>

<h2 id="3-composer-show-latest">3. composer show –latest</h2>

<p>Similar to composer outdated, <code class="language-plaintext highlighter-rouge">composer show --latest</code> shows you the latest version of each package that is available on
the remote repository. This can be helpful for keeping track of the latest package versions and deciding when to update
your project. The <code class="language-plaintext highlighter-rouge">composer show</code> command has a lot of other useful options that you can explore by running
<code class="language-plaintext highlighter-rouge">composer show --help</code>.</p>

<h2 id="4-composer-why--composer-why-not">4. composer why &amp; composer why-not</h2>

<p>Sometimes, when you try to install a package with Composer, it fails due to dependency conflicts or other issues. In
these situations, it can be difficult to determine why the package cannot be installed. This is where <code class="language-plaintext highlighter-rouge">composer why</code> and
<code class="language-plaintext highlighter-rouge">composer why-not</code> come in.</p>

<p><code class="language-plaintext highlighter-rouge">composer why</code> command tells you which other packages depend on a certain package. For example, you can run the
following command to find out which packages depend on <code class="language-plaintext highlighter-rouge">vimeo/psalm</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer why vimeo/psalm
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">composer why-not</code> shows you a detailed explanation of why a package cannot be installed, including all the packages
that are blocking it. This can be helpful for troubleshooting complex dependency issues. Specify a version constraint to
verify whether upgrades can be performed in your project, and if not why not. See the following example to find out why
PHPUnit 10 cannot be installed in your project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer why-not phpunit/phpunit 10
</code></pre></div></div>

<h2 id="5-composer-with-dependencies">5. composer –with-dependencies</h2>

<p>The <code class="language-plaintext highlighter-rouge">composer update</code>, <code class="language-plaintext highlighter-rouge">composer require</code>, and <code class="language-plaintext highlighter-rouge">composer remove</code> commands have a <code class="language-plaintext highlighter-rouge">--with-dependencies</code> and
<code class="language-plaintext highlighter-rouge">--with-all-dependencies</code> option that can be used to update all the dependencies of a package. This can be useful when
you want to update a package and all the packages that depend on it. For example, you can run the following command to
update the <code class="language-plaintext highlighter-rouge">symfony/console</code> package and all the packages that depend on it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer update symfony/console <span class="nt">--with-dependencies</span>
</code></pre></div></div>

<p>There are shortcuts for these options, you can use <code class="language-plaintext highlighter-rouge">-W</code> and <code class="language-plaintext highlighter-rouge">-w</code> instead of <code class="language-plaintext highlighter-rouge">--with-dependencies</code> and
<code class="language-plaintext highlighter-rouge">--with-all-dependencies</code>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">--with-dependencies (-w)</code>: Update also dependencies of packages in the argument list, except those which are root
requirements.</li>
  <li><code class="language-plaintext highlighter-rouge">--with-all-dependencies (-W)</code>: Update also dependencies of packages in the argument list, including those which are
root requirements.</li>
</ul>

<p>It’d be better to use the short versions as they work fine with different commands like <code class="language-plaintext highlighter-rouge">composer require</code> that has a
<code class="language-plaintext highlighter-rouge">--update-with-dependencies (-w)</code> and <code class="language-plaintext highlighter-rouge">--update-with-all-dependencies (-W)</code> option.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Upgrading your dependencies can be a tedious task, but it’s important to keep your project up-to-date. Using the
mentioned commands can help you resolve dependency issues and keep your project up-to-date. I hope you found this
article useful.</p>]]></content><author><name>Dhemy</name></author><category term="php" /><summary type="html"><![CDATA[Photo by Dayne Topkin on Unsplash]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://imdhemy.com/assets/img/glass-on-music-notes.jpeg" /><media:content medium="image" url="https://imdhemy.com/assets/img/glass-on-music-notes.jpeg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Back to dark theme</title><link href="https://imdhemy.com/blog/generic/back-to-dark-theme.html" rel="alternate" type="text/html" title="Back to dark theme" /><published>2023-04-09T00:00:00+00:00</published><updated>2023-04-09T00:00:00+00:00</updated><id>https://imdhemy.com/blog/generic/back-to-dark-theme</id><content type="html" xml:base="https://imdhemy.com/blog/generic/back-to-dark-theme.html"><![CDATA[<p>I always liked dark themes, but I came across
this <a href="https://stitcher.io/blog/why-light-themes-are-better-according-to-science">blog post</a> by Brent, and I thought I’d
give it a try. I installed the Light lite theme on my PHPStorm and WebStorm. In the beginning, it wasn’t comfortable,
but I thought I just needed to get used to it and I could
even <a href="https://github.com/imdhemy/phpstorm-light-lite-theme">modify the theme</a> to my liking.</p>

<p>I pushed myself to use it for around two months, but I couldn’t get used to it. Finally, I decided to go back to the
dark theme. I’m using the <a href="https://www.nordtheme.com/">Nord</a> theme, and I’m happy with it.</p>

<p>Whenever I google for “Dark theme vs Light theme”, I get a lot of articles, and YouTube videos, saying that light themes
are better for your eyes. I don’t know if that’s true, but I know that I’m more productive with dark themes.</p>

<p>It could be because I’m from the old school of using white chalk on a blackboard? 🤔😅</p>]]></content><author><name>Dhemy</name></author><category term="generic" /><summary type="html"><![CDATA[I always liked dark themes, but I came across this blog post by Brent, and I thought I’d give it a try. I installed the Light lite theme on my PHPStorm and WebStorm. In the beginning, it wasn’t comfortable, but I thought I just needed to get used to it and I could even modify the theme to my liking.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://imdhemy.com/assets/img/nord.png" /><media:content medium="image" url="https://imdhemy.com/assets/img/nord.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Approximating square roots with Newton’s method</title><link href="https://imdhemy.com/blog/dsa/approximating-square-roots-with-newton's-method.html" rel="alternate" type="text/html" title="Approximating square roots with Newton’s method" /><published>2022-12-12T11:55:59+00:00</published><updated>2022-12-12T11:55:59+00:00</updated><id>https://imdhemy.com/blog/dsa/approximating-square-roots-with-newton&apos;s-method</id><content type="html" xml:base="https://imdhemy.com/blog/dsa/approximating-square-roots-with-newton&apos;s-method.html"><![CDATA[<p>Newton’s method is a way to approximate the roots of an equation. The idea is to start with an initial guess, then to
approximate the function by its tangent line, and finally to compute the x-intercept of the tangent line. The
x-intercept is a better approximation of the root than the initial guess, and the process can be repeated until the
desired accuracy is reached.</p>

<p>Let’s say we need to find the square root of a number <code class="language-plaintext highlighter-rouge">a</code>. The equation we need to solve is \(f(x) = x^2 - a = 0\).</p>

<ol>
  <li>
    <p>We can start by drawing the curve of the function \(f(x)\) (Blue line in the figure below). The curve is a parabola
,but it shows only one root, the positive root.</p>
  </li>
  <li>
    <p>Then, we can start by choosing an initial guess \(x_n\) (Blue dashed line in the figure below). The tangent line at
the point \(x_n\) is \(f'(x_n) = 2x_n\) (Red line in the figure below). The x-intercept of the tangent line is the
next guess.</p>
  </li>
  <li>
    <p>As you can see, the next guess \(x_{n+1}\) is closer to the root than the previous guess \(x_n\). The process can be
repeated until the desired accuracy is reached.</p>
  </li>
</ol>

<p><img src="/assets/img/Newton_iteration.png" alt="Newton Iteration" /></p>

<p>So, we can approximate the square root of \(a\) by:</p>

\[x_{n+1} = x_n - \frac{f(x_n)}{f'(x_n)}\]

\[= x_n - \frac{x_n^2 - a}{2x_n}\]

\[= \frac{1}{2} (x_n + \frac{a}{x_n})\]

<p>We start with an initial guess \(x_0\) and then we iterate over the formula until we reach a desired accuracy. For
each step, we can calculate the error \(\epsilon\) as:</p>

\[\epsilon = \frac{|x_{n+1} - x_n|}{x_{n+1}}\]

<p>For example, if the first guess is \(x_0 = 1\), and the new guess is \(x_1 = 1.5\), then the error is:</p>

\[\epsilon = \frac{|1.5 - 1|}{1.5} = 0.333\]

<p>The error value ranges between \(0\) and \(1\), and the smaller the error, the closer we are to the square root of
\(a\). When the error equals \(0\), we have reached the square root of \(a\). We can also define an accepted error
so that we stop iterating when the error is less than the accepted error.</p>

<h2 id="example-1">Example (1)</h2>

<p>Let’s find the square root of \(a = 9\) using Newton’s method. We start with an initial guess \(x_0 = 1\), and then we
iterate over the formula until we reach a desired accuracy. This time, we will use an accepted error of \(0\). The
following table shows the steps:</p>

<table>
  <thead>
    <tr>
      <th>\(n\)</th>
      <th>\(x_n\)</th>
      <th>\(x_{n+1}\)</th>
      <th>\(\epsilon\)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>5</td>
      <td>0.8</td>
    </tr>
    <tr>
      <td>1</td>
      <td>5</td>
      <td>3.4</td>
      <td>0.47</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3.4</td>
      <td>3.023</td>
      <td>0.12</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3.023</td>
      <td>3.000091</td>
      <td>0.0076</td>
    </tr>
    <tr>
      <td>4</td>
      <td>3.000091</td>
      <td>3.000000092</td>
      <td>0.00003</td>
    </tr>
    <tr>
      <td>5</td>
      <td>3.000000092</td>
      <td>3.000000000</td>
      <td>0.00000003</td>
    </tr>
    <tr>
      <td>6</td>
      <td><strong>3</strong></td>
      <td>3</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

<p>As we can see, after the sixth step, the error is equal to \(0\), so we have reached the square root of \(9\).</p>

<h2 id="example-2">Example (2)</h2>

<p>Let’s find the square root of \(a = 16\) with an initial guess of \(x_0 = 1\) and an accepted error of \(0.1\).</p>

<table>
  <thead>
    <tr>
      <th>\(n\)</th>
      <th>\(x_n\)</th>
      <th>\(x_{n+1}\)</th>
      <th>\(\epsilon\)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>8.5</td>
      <td>0.88</td>
    </tr>
    <tr>
      <td>1</td>
      <td>8.5</td>
      <td>5.04</td>
      <td>0.69</td>
    </tr>
    <tr>
      <td>2</td>
      <td>5.04</td>
      <td>4.0016</td>
      <td>0.26</td>
    </tr>
    <tr>
      <td>3</td>
      <td><strong>4.0016</strong></td>
      <td>3.999904</td>
      <td>0.00004</td>
    </tr>
  </tbody>
</table>

<p>After the third step, the error is less than the accepted error, so we stop iterating. The square root of \(16\) is
\(4.0016\), which is close enough to the actual square root of \(16\) which is \(4\).</p>

<h2 id="implementation">Implementation</h2>

<p>The following code implements Newton’s method in Java:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewtonsMethod</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">sqrt</span><span class="o">(</span><span class="kt">double</span> <span class="n">a</span><span class="o">,</span> <span class="kt">double</span> <span class="n">x0</span><span class="o">,</span> <span class="kt">double</span> <span class="n">epsilon</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        
        <span class="k">while</span> <span class="o">(</span><span class="n">error</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">double</span> <span class="n">x1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">a</span> <span class="o">/</span> <span class="n">x</span><span class="o">);</span>
            <span class="n">error</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x</span><span class="o">)</span> <span class="o">/</span> <span class="n">x1</span><span class="o">;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x1</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="leetcode-problem">Leetcode problem</h2>

<p>We can use Newton’s method to solve the <a href="https://leetcode.com/problems/sqrtx/">69. Sqrt(x)</a> problem on Leetcode.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Solution</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">mySqrt</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">x0</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.00000000000001</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">sqrt</span> <span class="o">=</span> <span class="nc">NewtonsMethod</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">x0</span><span class="o">,</span> <span class="n">epsilon</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">sqrt</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The same problem can be solved using binary search:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Solution</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">mySqrt</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">long</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">x</span><span class="o">,</span> <span class="n">mid</span><span class="o">,</span> <span class="n">c</span><span class="o">;</span>

       <span class="k">while</span> <span class="o">(</span><span class="n">lo</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">lo</span><span class="o">;</span>
           <span class="n">c</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">*</span> <span class="n">mid</span><span class="o">;</span>

           <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">c</span><span class="o">)</span> <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">mid</span><span class="o">;</span>
           <span class="k">if</span><span class="o">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
           <span class="k">else</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">hi</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>]]></content><author><name>Dhemy</name></author><category term="dsa" /><summary type="html"><![CDATA[Newton’s method is a way to approximate the roots of an equation. The idea is to start with an initial guess, then to approximate the function by its tangent line, and finally to compute the x-intercept of the tangent line. The x-intercept is a better approximation of the root than the initial guess, and the process can be repeated until the desired accuracy is reached.]]></summary></entry><entry><title type="html">How to organize your unit tests</title><link href="https://imdhemy.com/blog/testing/how-to-organize-your-unit-tests.html" rel="alternate" type="text/html" title="How to organize your unit tests" /><published>2022-11-11T22:48:41+00:00</published><updated>2022-11-11T22:48:41+00:00</updated><id>https://imdhemy.com/blog/testing/how-to-organize-your-unit-tests</id><content type="html" xml:base="https://imdhemy.com/blog/testing/how-to-organize-your-unit-tests.html"><![CDATA[<p>One day, in the school of medicine, the lecturer told us an important thing about naming. He was explaining the
self-clearing mechanism of the airways in the respiratory system which is known as <strong>mucociliary escalator</strong> and he
said, to understand anything in medicine, you need to understand the idea behind the name, you need to understand the
culture behind the name. Check the following image, it auto-moves the particles outside the lungs like an escalator.</p>

<p>We are not native English speakers, so this advice applies to us.</p>

<p><img src="/assets/img/mucociliary-escalator.gif" alt="mucociliary escalator" />
<img src="/assets/img/escalator-fail.gif" alt="escalator fail" /></p>

<p>I believe it’s the same for programming, understanding the idea or the culture behind the name makes it easier to
understand the concept. So, let’s talk about the idea behind the names of the unit tests.</p>

<h2 id="the-names-in-testing">The names in testing</h2>

<p>In general, testing is finding out how well something works. In terms of human beings, testing tells what level of
knowledge or skill has been acquired. In terms of electronics, testing tells how well the device works.</p>

<p>The device under test is the thing that is being tested. In the case of testing car stability, the car is the device
under test. It’s referred to as <strong>DUT</strong>.</p>

<p>Engineers may use a device called <strong>test fixture</strong> to test the DUT. The test fixture is a device that is used to hold
the DUT in a specific position or to provide a particular input or output to the DUT. In the case of testing car
stability, the test fixture may be a ramp.</p>

<p>Let’s map this to programming. The DUT will be <strong>SUT</strong> (System under test). The test fixture is a piece of data that
could be a dependency or an argument passed to the SUT. It can also be data in the database or a file in the file
system.</p>

<div class="tip">
The test fixture's state and behavior should not change during the test, the ramp remains a ramp, or at least the changes should be predictable and controllable.
</div>

<h2 id="test-file-location">Test file location</h2>

<p>There are two conventions for organizing the test files. The first one is to put the test files in the same directory as
the source files. The second one is to put the test files in a separate directory. The first is called <strong>in-place</strong> and
the second is called <strong>out-of-place</strong>.</p>

<p><strong>In-place</strong> tests are painless to find, you see at a glance if a part of your application lacks tests. When you move
the source (inevitable), you remember to move the test, When you rename the source (inevitable), you remember to rename
the test. The downside is where to put integration tests, as they don’t belong to any specific source file. It’s often
better to create an appropriate directory for them in the <code class="language-plaintext highlighter-rouge">tests</code> directory.</p>

<p><strong>Out-of-place</strong> tests have a natural home directory <code class="language-plaintext highlighter-rouge">tests</code>. The directories and files in the <code class="language-plaintext highlighter-rouge">tests</code> directory should
mirror their corresponding source files. This way, you can easily integrate the tests with your IDE.</p>

<p>I prefer the <strong>out-of-place</strong> convention, even if I have to remember to move or rename the test files to reflect the
changes in the source files, but I’m not dogmatic about it. I’m open to changing my mind if I find a good reason to do
so.</p>

<h2 id="how-to-struct-a-test-case">How to struct a test case</h2>

<p>Structuring a test case starts with naming the test method. It’s often to encounter the following
pattern: <code class="language-plaintext highlighter-rouge">[MethodUnderTest]_[Scenario]_[ExpectedResult]</code>. I used to follow this pattern, but I found it not very
helpful. It focuses on the implementation details, not the behavior.</p>

<p>The pattern I prefer is PLAIN ENGLISH. We describe in plain English what we’re testing in a language easy to understand,
even for non-programmers.</p>

<p>Using plain English is required by the nature of some test frameworks. For example, in the case
of <a href="https://jestjs.io/">Jest</a>, the test method name is the test case name. So, you have to use plain English to name the
test method. You can do the same with the xUnit frameworks.</p>

<p>I also prefer to separate words by underscores, it makes it easier to read. I use snake case for the test method names,
even if the convention in the language or the framework is camel case. Yes, I know it’s not consistent and it breaks the
coding style, but I’m open to breaking rules if I find a good reason to do so. It’s easy to exclude the test files from
the coding style check of this rule.</p>

<p>The good reason here is readability, just compare the readability of the following two test method names:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ItShouldIlluminateTheLedAtLowLevelLight
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>It_should_illuminate_the_led_at_low_level_light
</code></pre></div></div>

<p>The snake case version is much easier to read, as it resembles the natural way of using spaces between words.</p>

<p><strong>So, what about the body of the test case?</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">Given-When-Then</code> or <code class="language-plaintext highlighter-rouge">Arrange-Act-Assert</code> is a great way to structure test cases. It prescribes an order of
operations:</p>

<h3 id="given-arrange">Given (Arrange)</h3>

<p>The <code class="language-plaintext highlighter-rouge">Given</code> section is where you set up the test case. You do all the preparations to make the test case ready to run.
You may require a fixture, a dependency, a database, a file, etc. You need also to set the initial state. This section
should end by creating the SUT instance in the initial state.</p>

<p>As far as I know, all xUnit frameworks provide a <code class="language-plaintext highlighter-rouge">setup</code> method to do the preparations. Even though this is not the
place to put the <code class="language-plaintext highlighter-rouge">Given</code> section.</p>

<div class="tip">
The `setup` method is not the place to put the `Given` section. The `setup` method is for the preparations that are common to all test cases. The `Given` section is for the preparations that are specific to the test case.
</div>

<p>Putting the <code class="language-plaintext highlighter-rouge">Given</code> section in the <code class="language-plaintext highlighter-rouge">setup</code> method is not a good idea, because it makes the test case less readable, and
it couples the test cases together. If you need to change the initial state of the SUT, you have to change the <code class="language-plaintext highlighter-rouge">setup</code>
method, which may break other tests. The <code class="language-plaintext highlighter-rouge">Given</code> section should be as close to the <code class="language-plaintext highlighter-rouge">When</code> section.</p>

<p>If your <code class="language-plaintext highlighter-rouge">Given</code> section has a boilerplate code, you can extract each part to a factory method with a descriptive name.
This way, you can reuse the factory method in other test cases.</p>

<p>For instance, <code class="language-plaintext highlighter-rouge">createUser()</code>, <code class="language-plaintext highlighter-rouge">createUserWithOrders()</code>, and <code class="language-plaintext highlighter-rouge">createUserWithOrdersAndPayments()</code> are factory methods that
create a user with a different initial state.</p>

<h3 id="when-act">When (Act)</h3>

<p>The <code class="language-plaintext highlighter-rouge">When</code> section is where you execute the action under test. It SHOULD be a single operation. If you need to execute
multiple operations, it’s a sign that you are not unit testing! You can find more about this in
the <a href="/blog/testing/what-is-a-unit-test">What is a unit test?</a> post.</p>

<h3 id="then-assert">Then (Assert)</h3>

<p>The <code class="language-plaintext highlighter-rouge">Then</code> section is where you assert the expected result. Assertions will ultimately determine the success or failure
of the test case. Each xUnit framework provides a set of assertion methods. You can use them to assert the expected
result or you can require a third-party assertion library. For example, <a href="https://www.chaijs.com/">Chai</a> is a popular
assertion library for Node.js. PHPUnit has a built-in assertion library, but Laravel provides a wrapper for
the <a href="https://laravel.com/docs/9.x/http-tests#available-assertions">PHPUnit assertions</a>.</p>

<h2 id="dont-abuse-database-fixtures-and-seeds">Don’t abuse database fixtures and seeds</h2>

<p>You may encounter a test suite that uses database fixtures to set the initial state of the database. This is a bad idea.
Do you remember when we said A RAMP IS A RAMP? if some data is going to change, it’s not a fixture anymore. The
downsides of using database fixtures are:</p>

<p>You have to run the DB fixtures before each test to prepare the initial state, which makes the test suite slow, and
coupled. The thing which breaks the test isolation.</p>

<p>Changing a state of a DB fixture in one test will affect the other tests, and it forces you to run them in a specific
order.</p>

<p>So, what’s a fixture then? A fixture is a piece of data that should not change during the test. It could be a JSON file
containing a particular response, a file to test the upload functionality, or a database record containing a global
configuration or a list of countries.</p>

<p><strong>Seeds</strong> are a different thing. Seeds are used to plant initial data to a Database. It’s extremely useful when you need
to populate your application with data once installed, let’s say an admin user or an example blog post. Seeds are not
used in the test suite.</p>

<p><strong>So, what’s the solution?</strong> use factories! Either factory methods or factory classes.</p>

<h2 id="summary">Summary</h2>

<p>In this post, we talked about the location of test files, <strong>in-place</strong> or <strong>out-of-place</strong>. We also talked about using
plain English to name the test methods and separating words by underscores. The <code class="language-plaintext highlighter-rouge">Given-When-Then</code>
or <code class="language-plaintext highlighter-rouge">Arrange-Act-Assert</code> is a great way to structure test cases. Do you remember what is a fixture? how to use them? and
the anti-patterns of the <code class="language-plaintext highlighter-rouge">Given</code> section.</p>]]></content><author><name>Dhemy</name></author><category term="testing" /><summary type="html"><![CDATA[One day, in the school of medicine, the lecturer told us an important thing about naming. He was explaining the self-clearing mechanism of the airways in the respiratory system which is known as mucociliary escalator and he said, to understand anything in medicine, you need to understand the idea behind the name, you need to understand the culture behind the name. Check the following image, it auto-moves the particles outside the lungs like an escalator.]]></summary></entry><entry><title type="html">What is a unit test</title><link href="https://imdhemy.com/blog/testing/what-is-a-unit-test.html" rel="alternate" type="text/html" title="What is a unit test" /><published>2022-08-13T17:21:35+00:00</published><updated>2022-08-13T17:21:35+00:00</updated><id>https://imdhemy.com/blog/testing/what-is-a-unit-test</id><content type="html" xml:base="https://imdhemy.com/blog/testing/what-is-a-unit-test.html"><![CDATA[<p>When I started writing this article few months ago, I got blocked by the 
idea of I’m going to write about something that everyone knows about and 
everyone can google the topic and found a ton of articles about the same 
basic topic. 
Should I publish such an article? As I said, I got blocked by this idea, the 
thing that stopped me from completing the series I started about <a href="/blog/testing/we-need-more-tests">testing</a>.</p>

<p>Finally, I decided to write this article to refer to it in case I 
needed in next articles, at least it will be an internal reference.</p>

<h2 id="what-is-a-unit-test">What is a unit test?</h2>
<p>You should already know about test automation. Given a piece of code, you 
can write another piece of code that verifies the behavior of the first. The 
second piece of code is called a unit test.</p>

<div class="tip">
    <p>A unit test should verify a small piece of code in isolation quickly.</p>
</div>

<p>As you can see, a unit test has three characteristics:</p>
<ul>
  <li>Verifies a small piece of code.</li>
  <li>Is quick to run.</li>
  <li>Works in isolation.</li>
</ul>

<p>A small piece of code could be a function, a class, a method, or whatever 
you can call a unit. If your test suite’s execution time is good enough to 
you, it means tests are quick enough.</p>

<div class="tip">
A <i>unit</i> in unit testing is a unit of behaviour, not a unit of 
<i>code</i>. This behaviour can span across as many as several classes or as 
a single method, but it should have a single entry point to trigger the behaviour.
</div>

<p>No doubt, the first two characteristics are non-controversial. The third one, isolation, is 
controversial. When it comes to isolation, there are two takes, the Mockist 
take and the Classicist take.</p>

<h2 id="mockist-take-vs-classicist-take">Mockist take vs Classicist take</h2>
<p>These two tribes are commonly referred to as the Detroit School of TDD 
(Classicist) and the London School of TDD (Mockist). A key difference 
between them is how they treat the dependencies of the code under test.</p>

<p>For the Mockist take, if a class has a dependency on another class or 
service, it is mocked or doubled. This means that isolation here is code 
isolation. But for the Classicist take, if a class has a dependency, the 
dependency should be used as it. It is not the code that needs to be 
isolated during testing. Instead, unit tests themselves should run in 
isolation from each other.</p>

<p>I believe that the style of mocking everything results in a fragile, hard to 
refactor code base. It does not reflect the real scenario, besides, it 
burdens your shoulders with maintaining the mocks when the real source code
changes. I’m not completely opposed to mocking, but we should mock to our 
advantage, wherever it makes our tests more manageable.</p>

<p>Another problem with the Mockist take is detecting changes in other services 
they are integrated with. For example, if a dependency behaviour changed, 
the mockist test will not detect it, it depends on a non-updated mock. Tests 
should be sensitive to the behavior changes and insensitive to the 
structural changes.</p>

<blockquote>
  <p>If I care about the order of operations, I’ve designed the system wrong. — <strong>Kent Beck (the Detroit School).</strong></p>
</blockquote>

<blockquote>
  <p>If I have an object that has behaviour, and I’m doing “Tell, Don’t Ask” then I can only test interactions. — <strong>Steve Freeman (the London School)</strong></p>
</blockquote>

<h2 id="when-to-mock-vs-when-to-use-real-dependencies">When to mock vs when to use real dependencies</h2>

<p>Hopefully, it’s clear now that I prefer the Classicist take. In the 
classicist take, it’s not the code that needs to be tested in an isolated 
manner. Instead, the unit tests themselves should be run in isolation from 
each other. The classes under test reside in the memory of the test runner, 
so that they can interact with each other without affecting the test results 
either you run the tests in parallel or in sequence.</p>

<p>There is a problem, Okay, they reside in the memory and not affecting 
each other, but what about the shared states? For example, the database and 
file system. Of course, changes in the database will affect the test results.
For instance, one test could create a record in the database, and the other 
test could delete the record as a part of its setup. If you run them in 
parallel, the first test will fail, not because the code is broken, but 
because it is not isolated.</p>

<p>Let’s look at three different types of dependencies: the <strong>shared</strong>, the <strong>private</strong> 
and the <strong>out-of-process</strong>. The shared dependencies are the ones that are 
shared across the test suite, for example, a static field, a database record,
and the file system.</p>

<p>The private dependencies are the ones that are not shared at all, for 
example a private field, or a function parameter.</p>

<p>The out-of-process dependencies are the ones that are the ones that run 
outside the application’s execution context. For example an external API.</p>

<p>Given the above, Classist take still can use mocks and test doubles, but 
only do that for the shared dependencies, or the out-of-process dependencies 
in case you need to test a specific behavior of the external service.</p>

<h2 id="conclusion">Conclusion</h2>
<p>Let’s conclude them in <strong>triplets</strong>:</p>

<p><strong>A unit test has three characteristics:</strong></p>
<ul>
  <li>Verifies a small piece of code.</li>
  <li>Is quick to run.</li>
  <li>Works in isolation.</li>
</ul>

<p><strong>There are three types of dependencies:</strong></p>
<ul>
  <li>Shared.</li>
  <li>Private.</li>
  <li>Out-of-process.</li>
</ul>

<p><strong>There are three schools of TDD:</strong></p>
<ul>
  <li>The Detroit School.</li>
  <li>The London School.</li>
  <li>The one that your manager told you to use.</li>
</ul>

<p><strong>There are three reasons to use mocks:</strong></p>
<ul>
  <li>Replacing the shared dependencies.</li>
  <li>The non-deterministic behavior of the out-of-process dependencies.</li>
  <li>To make tests faster. (Replacing DB calls for example.)</li>
</ul>]]></content><author><name>Dhemy</name></author><category term="testing" /><summary type="html"><![CDATA[When I started writing this article few months ago, I got blocked by the idea of I’m going to write about something that everyone knows about and everyone can google the topic and found a ton of articles about the same basic topic. Should I publish such an article? As I said, I got blocked by this idea, the thing that stopped me from completing the series I started about testing.]]></summary></entry><entry><title type="html">Math Notes about Sum Formulas</title><link href="https://imdhemy.com/blog/dsa/math-notes-about-sum-formulas.html" rel="alternate" type="text/html" title="Math Notes about Sum Formulas" /><published>2022-07-09T00:00:00+00:00</published><updated>2022-07-09T00:00:00+00:00</updated><id>https://imdhemy.com/blog/dsa/math-notes-about-sum-formulas</id><content type="html" xml:base="https://imdhemy.com/blog/dsa/math-notes-about-sum-formulas.html"><![CDATA[<p>I’m working on enhancing my skills, expanding my knowledge and increasing my chances to pass technical interviews. Mathematics plays an important role in problem-solving. Hence, this notes! This blog post is about <strong>Sum Formulas</strong>.</p>

<p class="note">
Each sum of the form:

$$ \sum_{x=1}^{n} x^{k} = 1^{k} + 2^{k} + 3^{k} + .. + n^{k} $$

where k is a positive integer, has a closed-form formula that is a polynomial of degree (k + 1).
</p>

<p><strong>Triangular number</strong></p>

\[\sum_{x=1}^{n} x = 1 + 2 + 3 + ... + n = \frac{n (n + 1)}{2}\]

<p><strong>Square pyramidal number</strong></p>

\[\sum_{x=1}^{n} x^{2} = 1^{2} + 2^{2} + 3^{2} + ... + n^{2} = \frac{n (n + 1) (2n + 1)}{6}\]

<p>There is a general formula for such sums, called <a href="https://en.wikipedia.org/wiki/Faulhaber%27s_formula">Faulhaber’s Formula</a>.</p>

<p>In the next lines, I’ll use mathematical induction to proof the Triangular number and the Square pyramidal number formulas.</p>

<h2 id="triangular-number">Triangular number.</h2>

<p class="note">
$$ \sum_{x=1}^{n} x = 1 + 2 + 3 + ... + n = \frac{n (n + 1)}{2} $$
</p>

<p><strong>Base step:</strong> Base case, for n = 1</p>

\[L.H.S = 1\]

\[R.H.S =  \frac{n (n + 1)}{2} = \frac{1 ( 1 + 1)}{2} = \frac{2}{2} = 1\]

\[L.H.S = R.H.S = 1\]

<hr />

<p><strong>Inductive hypothesis Step</strong>
The equation is true for an arbitrary integer <code class="language-plaintext highlighter-rouge">k</code></p>

\[1 + 2 + 3 + ... + k = \frac{k(k+1)}{2}\]

<hr />

<p><strong>Induction Step</strong></p>

<p>Based on the <strong>inductive hypothesis</strong>, let’s proof the equation if true for <code class="language-plaintext highlighter-rouge">n = k + 1</code></p>

\[L.H.S = 1 + 2 + 3 ... + k + k + 1\]

\[= \frac{k(k+1)}{2} + (k + 1)\]

\[= \frac{k(k+1)}{2} + \frac{2(k + 1)}{2}\]

\[= \frac{k^2 + k + 2k + 2}{2}\]

\[= \frac{k^2 + 3k + 2}{2}\]

\[= \frac{(k+1)(k+2)}{2}\]

\[= \frac{(k + 1)(k+1+1)}{2}\]

<hr />
<p>For <code class="language-plaintext highlighter-rouge">n = k + 1</code></p>

\[R.H.S = \frac{n(n + 1)}{2} =  \frac{(k+1)(K + 1 + 1)}{2}\]

\[L.H.S = R.H.S \#\]

<h2 id="square-pyramidal-number">Square pyramidal number</h2>

<p class="note">
$$ \sum_{x=1}^{n} x^{2} = 1^{2} + 2^{2} + 3^{2} + ... + n^{2} = \frac{n (n + 1) (2n + 1)}{6} $$
</p>

<p><strong>Base step:</strong> Base case, for n = 1</p>

\[L.H.S = 1^2 = 1\]

\[R.H.S = \frac{1(1+1)(2 \times 1 + 1)}{6} = \frac{2 \times 3}{6} = 1\]

\[L.H.S = R.H.S\]

<hr />

<p><strong>Inductive hypothesis Step</strong>
The equation is true for an arbitrary integer <code class="language-plaintext highlighter-rouge">k</code></p>

\[1^2 + 2^2 + 3^2 + ... + k^2 = \frac{k(k+1)(2k+1)}{6}\]

<hr />

<p><strong>Induction Step</strong></p>

<p>Based on the <strong>inductive hypothesis</strong>, let’s proof the equation if true for <code class="language-plaintext highlighter-rouge">n = k + 1</code></p>

\[L.H.S = 1^2 + 2^2 + 3^2 + ... + k^2 + (k+1)^2\]

\[= \frac{k(k+1)(2k+1)}{6} + (k+1)^2\]

\[= \frac{k(k+1)(2k+1)}{6} + \frac{6(k+1)^2}{6}\]

<p>Given the R.H.S:</p>

\[R.H.S = \frac{n(n+1)(2n+1)}{6} = \frac{(k+1)(k+2)(2k+3)}{6}\]

<p>So, we can ignore the <code class="language-plaintext highlighter-rouge">6</code> in the denominator from both sides for now:</p>

\[{L.H.S}\times{6} = k(k+1)(2k+1) + 6(k+1)^2\]

\[= (k^2 + k)(2k+1) + 6(k^2+2k+1)\]

\[= 2k^3 + k^2 + 2k^2 + k + 6k^2 + 12k + 6\]

\[{L.H.S}\times{6} = 2k^3 + 9k^2 + 13k + 6\]

<hr />

\[{R.H.S}\times{6} =  (k+1)(k+2)(2k+3)\]

\[= (k^2 + 3k + 2)(2k+3)\]

\[= 2k^3 + 6k^2 + 3k^2 + 4k + 9k + 6\]

\[{R.H.S}\times{6} = 2k^3 + 9k^2 + 13k + 6\]

<hr />

\[L.H.S = \frac{2k^3 + 9k^2 + 13k + 6}{6}\]

\[R.H.S =  \frac{2k^3 + 9k^2 + 13k + 6}{6}\]

\[R.H.S = L.H.S \#\]

<h2 id="number-progressions">Number Progressions</h2>
<p>A progression, which is also known as a sequence, is nothing but a pattern of numbers. For example, <code class="language-plaintext highlighter-rouge">3, 6, 9, 12</code> is a progression because there is a pattern observed where every number here is obtained by adding 3 to its previous number.</p>

<p>There are four types of the most common progressions.</p>

<h3 id="arithmetic-progression">Arithmetic Progression</h3>
<p>Arithmetic Progression (AP) is a sequence of numbers where the difference between any two consecutive numbers is constant.</p>

<p>For Example: <code class="language-plaintext highlighter-rouge">3, 7, 11, 15</code>, is an AP where the common difference is <code class="language-plaintext highlighter-rouge">4</code>.</p>

<p>For an AP:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">a</code> is the first term.</li>
  <li><code class="language-plaintext highlighter-rouge">l</code> is the last term.</li>
  <li><code class="language-plaintext highlighter-rouge">d</code> is the common difference.</li>
  <li>The <code class="language-plaintext highlighter-rouge">n</code> term could be found as follows: \(a_{n} = a + (n - 1) d\)</li>
  <li>We can find the <strong>sum</strong> as follows: \(S = \frac{n(a + l)}{2}\)</li>
</ul>

<p>Let’s proof this formula:</p>
<p class="note">
The sum of an arithmetic is 

$$ S = \frac{n(a + l)}{2} $$
</p>

<p>Suppose \(a_{1}, a_{2}, a_{3}, ..., a_{n}\) be an arithmetic progression whose first term is <code class="language-plaintext highlighter-rouge">a</code> and the common difference is <code class="language-plaintext highlighter-rouge">d</code>.</p>

<p>Then:</p>

\[a_{1} = a\]

\[a_{2} = a + d\]

\[a_{3} = a + 2d\]

\[a_{n} = a + (n - 1) d\]

<hr />

\[S_{n} = a + (a + d) + (a + 2d) + ... + \{a + (n - 3)d\} + \{a + (n - 2)d\} + \{a + (n - 1)d\} \;\;\;\;\;\;\;\; (i)\]

<p>And with a simple trick of reversing the order:</p>

\[S_{n} = \{a + (n - 1)d\} +  \{a + (n - 2)d\} + \{a + (n - 3)d\} + ... +  (a + 2d) + (a + d) + a  \;\;\;\;\;\;\;\; (ii)\]

<p>by adding \((i)\) and \((ii)\)</p>

<table>
  <thead>
    <tr>
      <th>Term (i)</th>
      <th>Term (ii)</th>
      <th>Sum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>a</td>
      <td>\(a + (n - 1)d\)</td>
      <td>\(2a + (n-1)d\)</td>
    </tr>
    <tr>
      <td>a + d</td>
      <td>\(a + (n - 2)d\)</td>
      <td>\(2a + (n-1)d\)</td>
    </tr>
    <tr>
      <td>a + 2d</td>
      <td>\(a + (n - 3)d\)</td>
      <td>\(2a + (n-1)d\)</td>
    </tr>
    <tr>
      <td>…</td>
      <td>…</td>
      <td>…</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>\(2S_{n} = n\{2a + (n-1)d\}\)</td>
    </tr>
  </tbody>
</table>

\[2S_{n} = \{2a + (n-1)d\} + \{2a + (n-1)d\} + ... + \{2a + (n-1)d\}\]

<hr />

\[2S_{n} = n\{2a + (n-1)d\}\]

\[2S_{n} = n\{a + a + (n-1)d\}\]

\[2S_{n} = n(a + l)\]

\[S_{n} = \frac{n(a+l)}{2} \#\]

<h3 id="geometric-progression">Geometric Progression</h3>
<p>Geometric Progression (GP) is a sequence of numbers where the ratio between any two consecutive numbers is constant.</p>

\[S = \frac{l\times k - a}{k - 1}\]

<h3 id="harmonic-progression">Harmonic Progression</h3>
<p>A series of numbers is said to be in harmonic sequence if the reciprocals (the inverse) of all the elements of the sequence form an arithmetic sequence.</p>

<p>For example:
\(\sum_{x=1}^{n}{\frac{1}{x}} = 1 + \frac{1}{2} +  \frac{1}{3} + ... + \frac{1}{n}\)</p>

<h3 id="fibonacci-progression">Fibonacci Progression</h3>
<p>Fibonacci numbers form an interesting sequence of numbers in which each element is obtained by adding two preceding elements and the sequence starts with <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">1</code>.</p>

<p>Sequence is defined as, 
\(F_{0} = 0\) and \(F_{1} = 1\) and \(F_{n} = F_{n-1} + F_{n-2}\)</p>]]></content><author><name>Dhemy</name></author><category term="DSA" /><summary type="html"><![CDATA[I’m working on enhancing my skills, expanding my knowledge and increasing my chances to pass technical interviews. Mathematics plays an important role in problem-solving. Hence, this notes! This blog post is about Sum Formulas.]]></summary></entry><entry><title type="html">We need more tests</title><link href="https://imdhemy.com/blog/testing/we-need-more-tests.html" rel="alternate" type="text/html" title="We need more tests" /><published>2022-01-31T06:05:51+00:00</published><updated>2022-01-31T06:05:51+00:00</updated><id>https://imdhemy.com/blog/testing/we-need-more-tests</id><content type="html" xml:base="https://imdhemy.com/blog/testing/we-need-more-tests.html"><![CDATA[<p>Well, It’s not about Coronavirus pandemic this time 😷. <a href="https://moisesbm.wordpress.com/">Moisés Belchín Martínez</a> (Moi),
my awesome ex-CTO, keeps repeating these words in every PR <strong>“We need more tests”</strong>. Sometimes it appears as a joke
about Covid-19, but I believe he totally meant it.</p>

<p>There’s a reason for optimism about your own code because you wrote it, it works, and you did your best following the
best practices of clean code, but is that enough to merge and release this code? TBH, No!</p>

<p>Moi doesn’t mean the quantity, but actually he meant the quality of tests we wrote to avoid
the <a href="https://www.atlassian.com/agile/software-development/technical-debt">technical debt</a> as much as possible by
having <a href="https://www.linkedin.com/feed/update/urn:li:activity:6886937179793223680?commentUrn=urn%3Ali%3Acomment%3A%28activity%3A6886937179793223680%2C6888937049659854849%29">a strict definition of Done</a>.
In this article, I’m discussing the metrics of code coverage, are they reliable enough? de we really need more tests?
How to measure a test suite quality? Vamos!</p>

<h2 id="what-is-the-goal-of-unit-testing">What is the goal of unit testing?</h2>

<p>A simple question, yet one that must be addressed! The goal of unit testing is to allow <strong>sustainable growth</strong> of the
software project. When you start a new project, you make progress so quickly, and get results with a little slaps on
your keyboard. No bad architectural decisions have been made yet. No requirement changes or existing code to worry
about. Actually, nothing is dragging you back. Eventually, the development speed slows down, and adding a new feature
may break another.</p>

<p>As per wikipedia, the idea that software eventually rots as it is changed is called <strong>Software entropy</strong>. Any code
modification leads to an amount of disorder in your code base. Leaving entropy without proper care, such as constant
cleaning and refactoring, the system becomes increasingly complex and disorganized.</p>

<p>Software entropy is tied to the notion of change and has no meaning in a static system. If there is no intent to alter
the system, we cannot speak of its entropy. One more idea to put in mind, when software entropy overwhelms a project,
the project freezes!</p>

<p>Tests act as a safety net. Tests help make sure the existing functionality works, even after you introduce new features
or refactor the code to better fit new requirements. Besides, it helps have a well-designed software.</p>

<h2 id="dont-just-throw-more-tests">Don’t just throw more tests</h2>

<p>Not all tests are created equal. Some of them are valuable and contribute a lot to overall software quality. Others
don’t. You can’t achieve the goal of unit testing by just throwing more tests at the project. Let’s discuss the *
*QUANTITY** aspect.</p>

<p><strong>Coverage metrics</strong> are used to show how much source code tests execute. It gives you a percentage from <code class="language-plaintext highlighter-rouge">0%</code> (No source
code executed) to <code class="language-plaintext highlighter-rouge">100%</code> (It covers all lines of code).</p>

<p>If a metric shows that is there too little coverage in your code base, say, only <code class="language-plaintext highlighter-rouge">10%</code>. That’s a good indication that
you are not testing enough. But the reverse isn’t true: even <code class="language-plaintext highlighter-rouge">100%</code> coverage isn’t a guarantee that you have a
good-quality test suite. A test suite that provides high coverage can still be of poor quality.</p>

<p>Consider the following example, using the code coverage as a metric.</p>

<p><strong>Read the code comments:</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">bool</span> <span class="nf">isBig</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// Not covered with test</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The following test calls the `isBig()` function. </span>
<span class="c1">// The if condition evaluates to `false`, then it returns false.</span>
<span class="c1">// This code executes (4) lines out of total (5) lines of code.</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">Test</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">bool</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">isBig</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="nc">Assertions</span><span class="o">.</span><span class="na">AssertFalse</span><span class="o">(</span><span class="n">actual</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>With a simple calculation using the code coverage formula:</p>

\[Code\ coverage = \frac{Lines\ of\ code\ executed}{Total\ number\ of\ lines}\]

\[Code\ coverage = \frac{4}{5} = 0.8 = 80\%\]

<p>Now, with the same test, what if we refactored our function to remove the unnecessary if condition:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="n">bool</span> <span class="nf">isBig</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When running our test again, it executes the full lines of code with <code class="language-plaintext highlighter-rouge">100%</code> coverage! The test still verifies the same
number of possible outcomes and without any improvement to our test suite, the test coverage percentage raised
from <code class="language-plaintext highlighter-rouge">80%</code> to <code class="language-plaintext highlighter-rouge">100%</code>.</p>

<p class="note">
Having a low test coverage is an indication of a bad test suite, but having a high number tells nothing about the <strong>QUALITY</strong> of the test suite.
</p>

<p>To enable sustainable project growth, you have to focus on high quality tests. Those are the only type of tests that are
worth keeping in the test suite.</p>

<h2 id="how-to-measure-a-test-suite-quality">How to measure a test suite quality?</h2>

<p>The only reliable way to measure a test suite quality is to evaluate each test individually. The point is there is no
automated way to see how good your test suite. You have to apply your personal judgement.</p>

<p>The only point in having automated tests is if you constantly use them. All tests should be integrated into the
development cycle, you should execute them on every change, even the smallest one.</p>

<p>It’s important to direct your unit testing efforts to the most critical parts of the system and verify the others only
briefly or indirectly. In most applications, the most important part is the part that contains the business logic (The
Domain Model).</p>

<h2 id="whats-next">What’s next?</h2>

<p>The only way to achieve the goal of unit testing is to learn how to differentiate between a good and a bad test, and you
should be able to refactor the test to make it more valuable.</p>

<p>I’ll discuss testing more and more in the next articles. This series of articles are inspired by a list of books and
courses including:</p>

<ul>
  <li>TDD Tutorial by Laracasts.</li>
  <li>Unit testing Principles, Practices and Patterns.</li>
  <li>Effective Unit Testing, a guide for java developers.</li>
</ul>

<p><strong>Manténganse al tanto</strong></p>]]></content><author><name>Dhemy</name></author><category term="testing" /><summary type="html"><![CDATA[Well, It’s not about Coronavirus pandemic this time 😷. Moisés Belchín Martínez (Moi), my awesome ex-CTO, keeps repeating these words in every PR “We need more tests”. Sometimes it appears as a joke about Covid-19, but I believe he totally meant it.]]></summary></entry><entry><title type="html">PHP Real-world use cases of singleton design pattern</title><link href="https://imdhemy.com/blog/php/real-world-use-cases-of-sinlgeton-in-php.html" rel="alternate" type="text/html" title="PHP Real-world use cases of singleton design pattern" /><published>2021-12-30T12:45:00+00:00</published><updated>2021-12-30T12:45:00+00:00</updated><id>https://imdhemy.com/blog/php/real-world-use-cases-of-sinlgeton-in-php</id><content type="html" xml:base="https://imdhemy.com/blog/php/real-world-use-cases-of-sinlgeton-in-php.html"><![CDATA[<p>The singleton pattern ensures that a class has only one instance and provides global access to it. Okay, many developers consider the singleton is an anti-pattern and many others don’t. The most common reason for using a singleton is to control access to some shared resources, database connection which is an expensive resource or a file.</p>

<p><strong>The singleton pattern is responsible for:</strong></p>
<ul>
  <li>Creating an instance of its class.</li>
  <li>Ensures that a class has just a single instance.</li>
</ul>

<p>This obviously violates the Single Responsibility Principle, as the pattern solves two problems at the same time.</p>

<p>In the following lines, I’ll start by explaining <strong>how to implement a singleton</strong>, then I’ll discuss how <strong>Laravel Container</strong> uses the singleton pattern, Finally, show you how the Local Adapter within <strong>Flysystem</strong> PHP package uses the same concept to manipulate files.</p>

<h2 id="how-to-implement-a-singleton">How to implement a singleton</h2>
<p>The Singleton class declares the static method <code class="language-plaintext highlighter-rouge">getInstance</code> that returns the same instance of its class. To do so, we declare a static private property that holds the instance. By checking its value we can decide whether to create a new instance or return the already instantiated one. The Singleton <code class="language-plaintext highlighter-rouge">constructor</code> should be hidden from the client code. Calling the <code class="language-plaintext highlighter-rouge">getInstance</code> method should be the only way to create an instance of the Singleton class. Cloning the object should be prevented as well.</p>

<p><strong>I start by writing tests…</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//SingletonTest.php
<span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Tests</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Com\Imdhemy\Singleton</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Error</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">SingletonTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_can_be_instantiated_by_a_static_factory_method</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$instance</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertInstanceOf</span><span class="p">(</span><span class="nc">Singleton</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="nv">$instance</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_must_return_the_same_instance_every_time</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$firstCall</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
        <span class="nv">$secondCall</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nv">$firstCall</span><span class="p">,</span> <span class="nv">$secondCall</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_should_not_be_instantiated_through_a_constructor</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">expectException</span><span class="p">(</span><span class="nc">Error</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="k">new</span> <span class="nc">Singleton</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_should_not_be_cloned</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">expectException</span><span class="p">(</span><span class="nc">Error</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="nv">$instance</span> <span class="o">=</span> <span class="nc">Singleton</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
        <span class="k">clone</span> <span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>And here is the Singleton class code…</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//Singleton.php
<span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Com\Imdhemy</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Singleton</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var Singleton|null
     */</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">?Singleton</span> <span class="nv">$instance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="cd">/**
     * Singleton constructor
     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>

    <span class="cd">/**
     * Prevents Cloning
     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="n">__clone</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return Singleton
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getInstance</span><span class="p">():</span> <span class="kt">Singleton</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="nv">$instance</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">static</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">static</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="why-laravel-container-is-a-special-singleton-class">Why Laravel Container is a special singleton class</h2>
<p>If you checked the <a href="https://github.com/laravel/framework/blob/8.x/src/Illuminate/Foundation/Application.php#L29">Laravel source code</a>, you will find that the <code class="language-plaintext highlighter-rouge">Application</code> class extends the <code class="language-plaintext highlighter-rouge">Container</code> class. The latter is a special singleton implementation. It makes sense to have a single instance of the application within your application.</p>

<p>You can easily find the <code class="language-plaintext highlighter-rouge">getInstance</code> <a href="https://github.com/laravel/framework/blob/8.x/src/Illuminate/Container/Container.php#L1382-L1389">method on the Container class</a>, but if you checked the container constructor, you <strong>will not</strong> find a private constructor. This is why I’m saying that the Laravel Container is a special singleton. It’s implemented in a way that gains the pros of a Singleton and avoids the cons.</p>

<p>Laravel developers are smart enough to realize that <em>it’s completely fine to have a single object within your application, but it’s not fine to make it impossible to make a second instance</em>.</p>

<h2 id="a-single-instance-of-a-file-counts-as-a-singleton">A single instance of a file counts as a singleton</h2>

<p>The term Singleton comes from mathematics. In mathematics, a Singleton, also known as a unit set, is a set with exactly one element. For example, the set <code class="language-plaintext highlighter-rouge">{M}</code> is a singleton containing the element <code class="language-plaintext highlighter-rouge">M</code>.</p>

<p>Let’s imagine the situation when a particular part of your application code is manipulating the contents of a local file, and another part is updating the same file simultaneously! For instance, the first one is adding to the file, and the other one is removing lines from there! Definitely, this will result in inconsistent file contents.</p>

<p>As a solution, we need to ensure having a single instance of the file resource on our application during manipulation. Actually this is not a singleton class implementation, but it still implies the mathematics definition of a singleton.</p>

<p>The wonderful <a href="https://github.com/thephpleague/flysystem">Flysystem</a> PHP package provides one interface to interact with many types of filesystems.</p>

<p>Flysystem ships with a default adapter, which is the Local adapter. By default, this adapter <a href="https://github.com/thephpleague/flysystem/blob/2.x/src/Local/LocalFilesystemAdapter.php#L87">uses a lock</a> during writes and updates.</p>

<h2 id="summary">Summary</h2>

<p>Singleton is a creational design pattern, which ensures that only one object of its kind exists and provides a single point of access to it for any other code.</p>

<p>I’d prefer to assign the responsibility of ensuring having only one object to another Class or helper or at least do the same as Laravel developers did, and I’d also avoid hiding the constructor.</p>

<p>It’s completely fine to have a single object within your application, but it’s not fine to make it impossible to make a second instance.</p>]]></content><author><name>Dhemy</name></author><category term="php" /><summary type="html"><![CDATA[The singleton pattern ensures that a class has only one instance and provides global access to it. Okay, many developers consider the singleton is an anti-pattern and many others don’t. The most common reason for using a singleton is to control access to some shared resources, database connection which is an expensive resource or a file.]]></summary></entry><entry><title type="html">How to test Elasticsearch in PHP applications</title><link href="https://imdhemy.com/blog/php/how-to-test-elasticsearch-in-php-apps.html" rel="alternate" type="text/html" title="How to test Elasticsearch in PHP applications" /><published>2021-09-09T00:00:00+00:00</published><updated>2021-09-09T00:00:00+00:00</updated><id>https://imdhemy.com/blog/php/how-to-test-elasticsearch-in-php-apps</id><content type="html" xml:base="https://imdhemy.com/blog/php/how-to-test-elasticsearch-in-php-apps.html"><![CDATA[<div class="caution">
<p>
Starting from Elasticsearch 8.0, they introduced multiple breaking changes in the Elasticsearch client library. 
This article is intended to v 7.x and lower. For v 8.0 you can use the <a href="https://github.
com/imdhemy/es-testing-utils">Es Utils package</a>.
</p>
</div>

<p>Currently, I’m working on the <a href="https://github.com/imdhemy/elasticsearch-php-sugar">Elasticsearch PHP Sugar package</a>. It’s a wrapper over the low-level Elasticsearch
client that adds <a href="https://en.wikipedia.org/wiki/Syntactic_sugar">syntactic sugar</a> for PHP developers. I’ll publish a blog post once I publish the first release.</p>

<p>One of the interesting things I have to work on is testing Elasticsearch in PHP. When unit-testing an external service,
you often need to simulate specific scenarios like returning a successful response, returning an error, or returning
particular responses in a certain order. In this blog post, I will show you how to add unit tests and integration tests
for Elasticsearch in your PHP application. Let’s start with a short note about the Practical Test Pyramid.</p>

<h3 id="practical-test-pyramid">Practical Test Pyramid</h3>

<p><img src="/assets/img/test-pyramid.png" alt="Test Pyramid" /></p>

<p>In his book <a href="https://www.goodreads.com/book/show/6707987-succeeding-with-agile"><em>Succeeding With Agile</em></a><em>,</em> Mike Cohn came up with the Test Pyramid concept. Test Pyramid tells you to
think about different layers of testing. It also tells you how much testing to do on each layer. It consists of three
layers from the bottom up:</p>

<ul>
  <li>Unit Tests.</li>
  <li>Service Tests.</li>
  <li>UI Tests.</li>
</ul>

<p>The names introduced by Mike Cohn are confusing, at least for me. I’ll go for different naming for each testing layer:</p>

<ul>
  <li>Unit Tests. It’s the same 😅</li>
  <li>Integration Tests.</li>
  <li>End to End Tests.</li>
</ul>

<p>As a rule of thumb, stick to the pyramid shape to come up with a healthy, fast, and maintainable test suite. Below is a
list of tips to follow:</p>

<ol>
  <li>Write tests with different granularity</li>
  <li>The more high-level you get the fewer tests you should have</li>
  <li>Write <em>lots</em> of small and fast <em>unit tests</em>.</li>
  <li>Write <em>some</em> more coarse-grained tests.</li>
  <li>Write <em>very few</em> high-level tests that test your application from end to end.</li>
</ol>

<p>In this blog post, I will cover only the first two types of the Test Pyramid. Unit and Integration Tests.</p>

<h3 id="how-to-unit-test-elasticsearch-in-php">How to Unit Test Elasticsearch in PHP</h3>

<p>Unit tests <a href="https://github.com/elastic/elasticsearch-php/pull/618#issuecomment-323816444">shouldn’t depend on a running cluster</a>, should be mocked out instead. To be more specific the client
response should be mocked.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">GuzzleHttp\Ring\Client\MockHandler</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Elasticsearch\ClientBuilder</span><span class="p">;</span>

<span class="c1">// The connection class requires 'body' to be a file stream handle</span>
<span class="c1">// Depending on what kind of request you do, you may need to set more values here</span>
<span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockHandler</span><span class="p">([</span>
  <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span>
  <span class="s1">'transfer_stats'</span> <span class="o">=&gt;</span> <span class="p">[</span>
     <span class="s1">'total_time'</span> <span class="o">=&gt;</span> <span class="mi">100</span>
  <span class="p">],</span>
  <span class="s1">'body'</span> <span class="o">=&gt;</span> <span class="nb">fopen</span><span class="p">(</span><span class="s1">'somefile.json'</span><span class="p">),</span>
  <span class="s1">'effective_url'</span> <span class="o">=&gt;</span> <span class="s1">'localhost'</span>
<span class="p">]);</span>
<span class="nv">$builder</span> <span class="o">=</span> <span class="nc">ClientBuilder</span><span class="o">::</span><span class="nf">create</span><span class="p">();</span>
<span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">setHosts</span><span class="p">([</span><span class="s1">'somehost'</span><span class="p">]);</span>
<span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">setHandler</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">build</span><span class="p">();</span>
<span class="c1">// Do a request and you'll get back the 'body' response above</span>
</code></pre></div></div>

<p>The previous example is provided by the official package maintainers. Besides, I don’t like the idea of using JSON
files, we may need to override some values or options during the runtime. This is why I created <a href="https://github.com/imdhemy/testing-es-in-php/tree/master/tests/Utils">these Utils</a> to be
used as follows:</p>

<hr />
<p><strong>[UPDATE: 5 November 2021: 02:21 PM]</strong>
I published a PHP package with enhanced <a href="https://github.com/imdhemy/es-testing-utils">Utils to test Elasticsearch</a>. You can use composer to install it.</p>

<hr />

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$handler</span> <span class="o">=</span> <span class="nc">MockHandler</span><span class="o">::</span><span class="nf">_mockTemplate_</span><span class="p">(</span><span class="s1">'index_document'</span><span class="p">);</span>
</code></pre></div></div>

<p>Just provide the template name to the <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Utils/MockHandler.php#L45">static method</a>, and it will do the rest for you. <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/fixtures/responses/index_document.php">The template</a> is a PHP
file that returns an array representing the expected client response.</p>

<p><strong>Here is an example of a unit test</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ElasticSearchEngineTest</span> <span class="kd">extends</span> <span class="nc">UnitTestCase</span>
<span class="p">{</span>
    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">test_it_can_index_a_document</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$handler</span> <span class="o">=</span> <span class="nc">MockHandler</span><span class="o">::</span><span class="nf">mockTemplate</span><span class="p">(</span><span class="s1">'index_document'</span><span class="p">);</span>

        <span class="nv">$builder</span> <span class="o">=</span> <span class="nc">ClientBuilder</span><span class="o">::</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">setHandler</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>
        <span class="nv">$client</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">build</span><span class="p">();</span>


        <span class="nv">$elasticSearchEngine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ElasticSearchEngine</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
        <span class="nv">$document</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'author'</span> <span class="o">=&gt;</span> <span class="s1">'Albert Einstein'</span><span class="p">,</span>
            <span class="s1">'quote'</span> <span class="o">=&gt;</span> <span class="s1">'I have no special talents. I am only passionately curious.'</span><span class="p">,</span>
        <span class="p">];</span>

        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$elasticSearchEngine</span><span class="o">-&gt;</span><span class="nf">index</span><span class="p">(</span><span class="s1">'quotes_index'</span><span class="p">,</span> <span class="nv">$document</span><span class="p">);</span>

        <span class="nv">$expectedResponse</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getTemplate</span><span class="p">(</span><span class="s1">'index_document'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$expectedResponse</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As simple as that 🚀</p>

<h3 id="how-to-add-integration-tests-to-elasticsearch-in-php">How to add Integration Tests to Elasticsearch in PHP</h3>

<div class="info">
 Github actions, Bitbucket pipelines and other CI/CD tools could be used to start Elasticsearch to run integration tests.
 The following example uses CircleCI, but it would be much better if you used the same tool you're using in your project
without depending on a third-party service.
</div>

<p>For this part, you don’t just need to run your application but also the component you’re integrating with, Elasticsearch
in our case. To automate this process I’m going to use <a href="https://circleci.com/">CircleCI</a>. CircleCI integrates with GitHub and Bitbucket, in
our example project we will use Github, but you can do the same on Bitbucket.</p>

<p>Let’s create our configuration file. Don’t be worry if you didn’t use CircleCI before, all you need is to understand the
following YAML file.</p>

<p>on <code class="language-plaintext highlighter-rouge">.circleci/config.yml</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># PHP8.0 &amp; ES7.14.0 CircleCI 2.0 configuration file</span>
<span class="c1">#</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/php:8.0.10-cli</span> <span class="c1">#1</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.14.0</span> <span class="c1">#2</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="c1">#3</span>
          <span class="pi">-</span> <span class="na">transport.host</span><span class="pi">:</span> <span class="s">localhost</span>
          <span class="pi">-</span> <span class="na">network.host</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
          <span class="pi">-</span> <span class="na">http.port</span><span class="pi">:</span> <span class="m">9200</span>
          <span class="pi">-</span> <span class="na">cluster.name</span><span class="pi">:</span> <span class="s">es-cluster</span>
          <span class="pi">-</span> <span class="na">discovery.type</span><span class="pi">:</span> <span class="s">single-node</span>
          <span class="pi">-</span> <span class="na">xpack.security.enabled</span><span class="pi">:</span> <span class="kc">false</span>
          <span class="pi">-</span> <span class="na">ES_JAVA_OPTS</span><span class="pi">:</span> <span class="s2">"</span><span class="s">-Xms256m</span><span class="nv"> </span><span class="s">-Xmx256m"</span>
    <span class="na">steps</span><span class="pi">:</span> <span class="c1">#4</span>
      <span class="pi">-</span> <span class="s">checkout</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">sudo apt update</span>

      <span class="c1"># Download and cache dependencies</span>
      <span class="pi">-</span> <span class="na">restore_cache</span><span class="pi">:</span>
          <span class="na">keys</span><span class="pi">:</span>
            <span class="c1"># "composer.lock" can be used if it is committed to the repo</span>
            <span class="pi">-</span> <span class="s">v1-dependencies-{{ checksum "composer.json" }}</span>
            <span class="c1"># fallback to using the latest cache if no exact match is found</span>
            <span class="pi">-</span> <span class="s">v1-dependencies-</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">composer install -n --prefer-dist</span>

      <span class="c1"># Wait for ES startup</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="c1">#5</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Waiting for Elasticsearch</span>
          <span class="na">command</span><span class="pi">:</span> <span class="s">dockerize --wait http://localhost:9200 -timeout 1m</span>
      <span class="c1"># run tests with phpunit</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">composer test</span> <span class="c1">#6</span>

</code></pre></div></div>

<p>I’m using docker images to build my application, <code class="language-plaintext highlighter-rouge">#1</code> for <strong>PHP8.0</strong> and <code class="language-plaintext highlighter-rouge">#2</code> for the <strong>Elasticsearch</strong> prebuild image.
CircleCI provides other ways to start your machine, but docker 🐳 is super easy to use.</p>

<p><code class="language-plaintext highlighter-rouge">#3</code> is the environment variables used for Elasticsearch configuration.</p>

<p>Number <code class="language-plaintext highlighter-rouge">#4</code> shows the build job steps, but give more attention to <code class="language-plaintext highlighter-rouge">#5</code> which allows our test suites to wait for
Elasticsearch to be ready. Finally, on <code class="language-plaintext highlighter-rouge">#6</code> we are using composer to run PHPUnit Tests.</p>

<p><strong>Let’s add the first integration test.</strong> For your local development, you can depend on the docker-compose to start
Elasticsearch.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up -d
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SearchEngineTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="cd">/**
     * @test
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">test_get_client_info</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$client</span> <span class="o">=</span> <span class="nc">ClientBuilder</span><span class="o">::</span><span class="nf">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">build</span><span class="p">();</span>
        <span class="nv">$searchEngine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ElasticSearchEngine</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
        <span class="nv">$info</span> <span class="o">=</span> <span class="nv">$searchEngine</span><span class="o">-&gt;</span><span class="nf">info</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertArrayHasKey</span><span class="p">(</span><span class="s1">'tagline'</span><span class="p">,</span> <span class="nv">$info</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'You Know, for Search'</span><span class="p">,</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'tagline'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Final steps:</strong></p>

<p><img src="/assets/img/circle-ci-es-php-app.png" alt="CircleCi Dashboard" /></p>

<ul>
  <li>Push your code to GitHub.</li>
  <li><a href="https://app.circleci.com/">Give CircleCI access</a> to this repository.</li>
  <li>And watch your integration tests running. 🚀 🔥</li>
</ul>

<h3 id="summary">Summary</h3>

<p>I have created a <a href="https://github.com/imdhemy/testing-es-in-php">repository of an example application</a>. You can clone it and start playing with code. It requires
PHP.8 installed on your host machine. If you prefer PHP7, you can checkout to PHP7.3 branch.</p>

<p>It would be better if completed the exercises I added for you.</p>

<ul>
  <li>Exercise No.1: <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Unit/ElasticSearchEngineTest.php#L39">Add a unit test for search by a keyword.</a></li>
  <li>Exercise No.2: <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Integration/SearchEngineTest.php#L26">Add an integration test for indexing a document.</a></li>
  <li>Exercise No.3: <a href="https://github.com/imdhemy/testing-es-in-php/blob/master/tests/Integration/SearchEngineTest.php#L35">Add an integration test for searching for a keyword.</a></li>
</ul>

<p>Feel free to make a PR of your answers.</p>]]></content><author><name>Dhemy</name></author><category term="php" /><summary type="html"><![CDATA[Starting from Elasticsearch 8.0, they introduced multiple breaking changes in the Elasticsearch client library. This article is intended to v 7.x and lower. For v 8.0 you can use the Es Utils package.]]></summary></entry><entry><title type="html">Why you need a builder to create your entities and models</title><link href="https://imdhemy.com/blog/php/why-you-need-a-builder-to-create-your-entities-and-models.html" rel="alternate" type="text/html" title="Why you need a builder to create your entities and models" /><published>2021-06-02T00:01:38+00:00</published><updated>2021-06-02T00:01:38+00:00</updated><id>https://imdhemy.com/blog/php/why-you-need-a-builder-to-create-your-entities-and-models</id><content type="html" xml:base="https://imdhemy.com/blog/php/why-you-need-a-builder-to-create-your-entities-and-models.html"><![CDATA[<p><a href="/blog/php/three-advantages-of-using-static-factory-methods-in-php.html">Static factories</a> and constructors share a limitation; they do not scale well to large numbers of optional parameters. Consider the case of a class presenting a <strong>User</strong> on a social network platform. This class has only three required fields (<code class="language-plaintext highlighter-rouge">$name</code>, <code class="language-plaintext highlighter-rouge">$email</code> &amp; <code class="language-plaintext highlighter-rouge">$password</code>) and a bunch of optional fields with default values, for instance: (<code class="language-plaintext highlighter-rouge">$address</code>, <code class="language-plaintext highlighter-rouge">$avatar</code>, <code class="language-plaintext highlighter-rouge">$gender</code>, <code class="language-plaintext highlighter-rouge">$emailVerifiedAt</code>, etc…).</p>

<p><em><strong>As a side note:</strong> this is not my preferred way to design a user entity, but this is only here for purpose of clarifying the situation of having a long parameter list.</em></p>

<p>Starting from here, I’ll explore the practices I previously did or noticed in other developers’ code.</p>

<h2 id="the-laravel-models-taste">The Laravel models taste</h2>
<p>Laravel models provide two methods to create a model instance, the most popular <code class="language-plaintext highlighter-rouge">create</code> method and the less popular <code class="language-plaintext highlighter-rouge">make</code> method. Both methods are not implemented in the base <code class="language-plaintext highlighter-rouge">Model</code> class. But Laravel defines a <code class="language-plaintext highlighter-rouge">__call()</code> and <code class="language-plaintext highlighter-rouge">__callStatic()</code> methods, it goes handled through them. <a href="https://github.com/laravel/framework/blob/8.x/src/Illuminate/Database/Eloquent/Model.php#L1952">Those methods forward the call to a query builder!</a></p>

<p>Finally, we have a model class that has no properties, a parameterless constructor! Everything is injected magically into the class.</p>

<p>The Model class looks like the following snippet:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">Model</span>
<span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The client code be like:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">([</span>
    <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'John Doe'</span><span class="p">,</span>
    <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'john@example.com'</span><span class="p">,</span>
    <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nv">$passwordHash</span>
<span class="p">]);</span>
</code></pre></div></div>
<p><strong>IMHO, this is not so good due to the following reasons!</strong></p>

<ul>
  <li>Sooner or later, you’ll end up with a model with <strong>an invalid state</strong> or any <a href="https://www.php.net/manual/en/language.oop5.overloading.php#119407">kind of unexpected behavior</a>.</li>
  <li>The model <strong>has no properties</strong> and even more if you defined the properties to solve this problem the code will break!</li>
  <li>All properties are treated as public properties which means <strong>no encapsulation</strong> at all!</li>
  <li>Your <strong>IDE doesn’t understand</strong> that!</li>
  <li>You need to <strong>check your schema</strong> in a repeated manner to remember the properties and their types.</li>
  <li>Feel free to add more problems to this list…</li>
</ul>

<h2 id="a-factory-that-accepts-an-array-of-attributes">A factory that accepts an array of attributes</h2>
<p>Another technique I noticed some developers use is to provide a factory that receives an array of attributes, then starts a series of <code class="language-plaintext highlighter-rouge">isset</code> calls accompanied by a call to a setter method!</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">Entity</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$email</span><span class="p">;</span>
    
    <span class="c1">// and so on ...</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">setName</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">setEmail</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$email</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// ... </span>
    
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$attributes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">();</span>
        
        <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]))</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">setName</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">setEmail</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]);</span>
        <span class="c1">// ... Pew Pew Pew</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Just imagine repeating this to cover all the class properties!</p>

<ul>
  <li>With <strong>parameterless constructors</strong>, you need to handle the required params yourself!</li>
  <li>Again, have entities with <strong>an invalid state</strong>!</li>
  <li><strong>Hard to read</strong>, hard to maintain code.</li>
  <li>Your <strong>IDE doesn’t understand</strong> that!</li>
</ul>

<h2 id="telescoping-constructor">Telescoping constructor</h2>
<p>Telescoping constructor means to provide a constructor with only the required parameters, another with a single optional parameter, a third with two optional parameters, and so on.</p>

<p>Since PHP doesn’t allow constructor overloading, PHP developers started to provide a constructor with a full list of properties starting with the required params.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="c1">// .. </span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$email</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$password</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$foo</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$bar</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="kt">?Address</span> <span class="nv">$address</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">?File</span> <span class="nv">$avatar</span><span class="o">=</span><span class="kc">null</span><span class="p">,</span> <span class="kt">?DateTime</span> <span class="nv">$createdAt</span><span class="o">=</span><span class="kc">null</span><span class="p">)</span>
    <span class="p">{</span>
       <span class="c1">// ..</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>When you want to create an instance, you can pass the shortest list of parameters you want to set. Typically, this constructor invocation will require many parameters that you don’t want to set, but you are forced to pass a value for them.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="s1">'John Doe'</span><span class="p">,</span> <span class="s1">'john@example.com'</span><span class="p">,</span> <span class="nv">$passwordHash</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">$avatar</span><span class="p">);</span>
</code></pre></div></div>
<p>In this case, we’re forced to pass <code class="language-plaintext highlighter-rouge">5, 12, null</code> values which are the default values since the avatar comes after them in order!</p>

<p>The telescoping constructor work, but it is hard to write client code when there are many parameters, and harder still to read it. The reader is left wondering what all those values mean and must carefully count parameters to find out. Umm, what if he swapped the <code class="language-plaintext highlighter-rouge">12</code> and <code class="language-plaintext highlighter-rouge">50</code> since having the same data type, the code won’t break, but it’s an invalid state again!</p>

<h2 id="fluent-setters">Fluent Setters</h2>
<p>Fluent Setters is the PHP way to imitate the <a href="https://en.wikipedia.org/wiki/JavaBeans">JavaBeans</a> Pattern In which you call a parameterless constructor followed by call to setter methods. It’s called fluent because all setter methods return the object instance allowing you to call them in chains.</p>

<p>This pattern has none of the disadvantages of the telescoping constructor pattern. It makes it easy to create instances, and easy to read the resulting code:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">();</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">setName</span><span class="p">(</span><span class="s1">'John Doe'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setEmail</span><span class="p">(</span><span class="s1">'john@example.com'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="nv">$passwordHash</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">setAddress</span><span class="p">(</span><span class="s1">'Via Lactea'</span><span class="p">);</span>
</code></pre></div></div>

<p>Unfortunately, the Fluent setters pattern has the following disadvantages:</p>
<ul>
  <li>A class with a parameterless constructor is subject to being instantiated in <strong>an invalid state</strong>.</li>
  <li>Having to create setters for every property leads to an immense quantity of <strong>boilerplate code</strong>.</li>
</ul>

<h2 id="using-a-builder-is-a-good-solution">Using a builder is a good solution!</h2>
<p>We can use a form of the <a href="https://refactoring.guru/design-patterns/builder">Builder Pattern</a> which combines the safety of the telescoping constructors and the readability of the fluent setters. Instead of creating the desired object directly, the client calls a static factory method with all the required parameters and gets an object of the builder class which provides setter-like methods for other optional methods. Finally, the client calls a parameterless <code class="language-plaintext highlighter-rouge">build</code> method to get an instance of the required class. Let me show you an example:</p>

<p><strong>I prefer to start with The Client Code:</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @test
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">test_builder_can_create_user</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">builder</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="nf">name</span><span class="p">(</span><span class="s1">'John Doe'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">email</span><span class="p">(</span><span class="s1">'john@example.com'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">address</span><span class="p">(</span><span class="s1">'Via Lactea'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">build</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertInstanceOf</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
    <span class="c1">// More assertions...</span>
<span class="p">}</span>
</code></pre></div></div>
<p><strong>Then the Entity class:</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var string
     */</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="cd">/**
     * @var string
     */</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$email</span><span class="p">;</span>

    <span class="cd">/**
     * @var string
     */</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$address</span><span class="p">;</span>
    
    <span class="c1">//More attributes...</span>
    <span class="c1">//...</span>

    <span class="cd">/**
     * You can use one of the following options for the constructor:
     * 1. Parameterless constructor &amp; add a static factory method that accepts the UserBuilder as a param
     * 2. A constructor that accepts the UserBuilder as a param.
     * User constructor.
     * @param \App\UserBuilder $builder
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">UserBuilder</span> <span class="nv">$builder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">getEmail</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="nf">getAddress</span><span class="p">();</span>
        <span class="c1">// .. Set other attributes</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return \App\UserBuilder
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">builder</span><span class="p">():</span> <span class="kt">UserBuilder</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">UserBuilder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getName</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param string $name
     * @return User
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setName</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">User</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getEmail</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param string $email
     * @return User
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setEmail</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$email</span><span class="p">):</span> <span class="kt">User</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getAddress</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param string $address
     * @return User
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setAddress</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$address</span><span class="p">):</span> <span class="kt">User</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="nv">$address</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><strong>Finally, the Builder class:</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">UserBuilder</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var string
     */</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="cd">/**
     * @var string
     */</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$email</span><span class="p">;</span>

    <span class="cd">/**
     * @var string
     */</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$address</span><span class="p">;</span>

    <span class="cd">/**
     * @param string $name
     * @return $this
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">name</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param string $email
     * @return $this
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">email</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$email</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param string $address
     * @return $this
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">address</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$address</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="nv">$address</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getName</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getEmail</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getAddress</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return \App\User
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">():</span> <span class="kt">User</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Note:</strong> The previous example uses a parameterless <code class="language-plaintext highlighter-rouge">UserBuilder</code> constructor, but you should add the required attributes as parameters to confirm creating an object in a valid state.</p>

<h2 id="summary">Summary</h2>
<p>In summary, the Builder pattern is a good choice when designing classes whose constructors or static factories would have more than a handful of parameters, especially if much of the parameters are optional or of identical type. Client code is much easier to read and write with builders than with telescoping constructors, and builders are much safer than the Fluent setters.</p>]]></content><author><name>Dhemy</name></author><category term="php" /><summary type="html"><![CDATA[Static factories and constructors share a limitation; they do not scale well to large numbers of optional parameters. Consider the case of a class presenting a User on a social network platform. This class has only three required fields ($name, $email &amp; $password) and a bunch of optional fields with default values, for instance: ($address, $avatar, $gender, $emailVerifiedAt, etc…).]]></summary></entry></feed>